var songJSON = {
	"songLen": 29,
	"songData": [{
		"osc1_oct": 7,
		"osc1_det": 0,
		"osc1_detune": 0,
		"osc1_xenv": 0,
		"osc1_vol": 127,
		"osc1_waveform": 1,
		"osc2_oct": 6,
		"osc2_det": 0,
		"osc2_detune": 9,
		"osc2_xenv": 0,
		"osc2_vol": 93,
		"osc2_waveform": 1,
		"noise_fader": 0,
		"env_attack": 137,
		"env_sustain": 2000,
		"env_release": 4611,
		"env_master": 192,
		"fx_filter": 1,
		"fx_freq": 982,
		"fx_resonance": 89,
		"fx_delay_time": 6,
		"fx_delay_amt": 25,
		"fx_pan_freq": 6,
		"fx_pan_amt": 77,
		"lfo_osc1_freq": 0,
		"lfo_fx_freq": 1,
		"lfo_freq": 3,
		"lfo_amt": 69,
		"lfo_waveform": 0,
		"p": [
			1,
			1,
			1,
			1,
			2,
			2
		],
		"c": [{
			"n": [
				0,
				135,
				135,
				135,
				135,
				135,
				135,
				135,
				135,
				135,
				135,
				135,
				135,
				135,
				0,
				0,
				135,
				140,
				140,
				0,
				0,
				0,
				0,
				140,
				137,
				0,
				135,
				135,
				135,
				0,
				0,
				0
			]
		}, {
			"n": [
				0,
				142,
				142,
				142,
				142,
				142,
				142,
				142,
				142,
				142,
				142,
				142,
				142,
				142,
				0,
				0,
				142,
				147,
				147,
				0,
				0,
				0,
				0,
				147,
				144,
				0,
				142,
				142,
				142,
				0,
				0,
				0
			]
		}]
	}, {
		"osc1_oct": 7,
		"osc1_det": 0,
		"osc1_detune": 0,
		"osc1_xenv": 0,
		"osc1_vol": 192,
		"osc1_waveform": 2,
		"osc2_oct": 7,
		"osc2_det": 0,
		"osc2_detune": 0,
		"osc2_xenv": 0,
		"osc2_vol": 201,
		"osc2_waveform": 3,
		"noise_fader": 0,
		"env_attack": 100,
		"env_sustain": 150,
		"env_release": 13636,
		"env_master": 191,
		"fx_filter": 2,
		"fx_freq": 5839,
		"fx_resonance": 254,
		"fx_delay_time": 6,
		"fx_delay_amt": 121,
		"fx_pan_freq": 6,
		"fx_pan_amt": 147,
		"lfo_osc1_freq": 0,
		"lfo_fx_freq": 1,
		"lfo_freq": 6,
		"lfo_amt": 195,
		"lfo_waveform": 0,
		"p": [
			2,
			2,
			2,
			2,
			3,
			3
		],
		"c": [{
			"n": [
				135,
				0,
				135,
				0,
				0,
				135,
				0,
				135,
				135,
				0,
				135,
				0,
				0,
				135,
				0,
				135,
				135,
				0,
				135,
				0,
				0,
				135,
				0,
				135,
				135,
				0,
				135,
				0,
				0,
				135,
				0,
				135
			]
		}, {
			"n": [
				135,
				0,
				0,
				0,
				135,
				0,
				0,
				0,
				135,
				0,
				0,
				0,
				135,
				0,
				0,
				0,
				135,
				0,
				0,
				0,
				135,
				0,
				0,
				0,
				135,
				0,
				0,
				0,
				135,
				0,
				0,
				0
			]
		}, {
			"n": [
				149,
				0,
				0,
				0,
				149,
				0,
				0,
				0,
				149,
				0,
				0,
				0,
				149,
				0,
				0,
				0,
				149,
				0,
				0,
				0,
				149,
				0,
				0,
				0,
				149,
				0,
				0,
				0,
				149,
				0,
				0,
				0
			]
		}]
	}, {
		"osc1_oct": 7,
		"osc1_det": 0,
		"osc1_detune": 0,
		"osc1_xenv": 0,
		"osc1_vol": 192,
		"osc1_waveform": 2,
		"osc2_oct": 7,
		"osc2_det": 0,
		"osc2_detune": 0,
		"osc2_xenv": 0,
		"osc2_vol": 201,
		"osc2_waveform": 3,
		"noise_fader": 0,
		"env_attack": 100,
		"env_sustain": 150,
		"env_release": 13636,
		"env_master": 191,
		"fx_filter": 2,
		"fx_freq": 5839,
		"fx_resonance": 254,
		"fx_delay_time": 6,
		"fx_delay_amt": 121,
		"fx_pan_freq": 6,
		"fx_pan_amt": 147,
		"lfo_osc1_freq": 0,
		"lfo_fx_freq": 1,
		"lfo_freq": 6,
		"lfo_amt": 195,
		"lfo_waveform": 0,
		"p": [
			1,
			1,
			1,
			1,
			2,
			2
		],
		"c": [{
			"n": [
				154,
				0,
				151,
				0,
				0,
				156,
				152,
				0,
				0,
				154,
				0,
				0,
				151,
				0,
				156,
				0,
				0,
				152,
				0,
				0,
				154,
				0,
				0,
				151,
				0,
				0,
				154,
				154,
				0,
				0,
				0,
				0
			]
		}, {
			"n": [
				161,
				0,
				158,
				0,
				0,
				163,
				159,
				0,
				0,
				161,
				0,
				0,
				158,
				0,
				163,
				0,
				0,
				159,
				0,
				0,
				161,
				0,
				0,
				158,
				0,
				0,
				161,
				161,
				0,
				0,
				0,
				0
			]
		}]
	}],
	"rowLen": 5606,
	"endPattern": 7
};

var songGen = MusicGenerator(songJSON);
var source, sourceBuffer;
createAudioBuffer(songGen, function(buffer) {
	sourceBuffer = buffer;
	toggle();
});
var playing = false;
var startOffset = 0;
var startTime = 0;

function toggle() {
	if (playing) {
		source.stop();
		// Measure how much time passed since the last pause.
		startOffset += audioCtx.currentTime - startTime;
	} else {
		startTime = audioCtx.currentTime;
		source = audioCtx.createBufferSource();
		// Connect graph
		source.buffer = sourceBuffer;
		source.loop = true;
		source.connect(audioCtx.destination);
		// Start playback, but make sure we stay in bound of the buffer.
		source.start(0, startOffset % sourceBuffer.duration);
	}
	playing = !playing;
};