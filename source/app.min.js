!function(n,t){function r(){var n,t,r,i,a,h,d,u,f,y,x,g,p,w,v,b,k,M,F;for(tt(),m(Ht,Er.c.bd,Er.c.bd,2),Ht.fillRect(0,0,Lt.width,Lt.height),Ht.fillStyle=Er.c.bg,Ht.clearRect(0-kr,0-Mr,or,er),n=E(kr)-1,t=E(Mr)-1,r=E(kr)+E(It.width)+2,i=E(Mr)+E(It.height)+2,0>n&&(n=0),0>t&&(t=0),r>rr&&(r=rr),i>rr&&(i=rr),a={},h=t;i>h;h++)for(d=0,u=16*-rr*2,f=0,m(Ht,Er.c.bg,!1,!1),x=n;r>x;x++)g=W(x,h,rr),1===fr[g]&&(d+=16,u===16*-rr*2&&(u=16*x-kr),y=0>h-1?-1:fr[W(x,h-1,rr)],0===y&&(f=1)),(1!==fr[g]||x===r-1)&&(p=u,w=16*h-Mr,f?c(Ht,!0,!1,p,w-5,d,21):c(Ht,!0,!1,p,w,d,16)),(1!==fr[g]||x===r-1)&&(d=0,u=16*-rr*2,f=0);for(h=t;i>h;h++)for(x=n;r>x;x++)g=W(x,h,rr),v=fr[g],v>1&&(9===v&&Er.s>-1?(m(Ht,Ar[Er.s].l,Ar[Er.s].bd,2),l(Ht,16*x+8-kr-8,16*h+8-Mr,8,!0)):9!==v&&10!==v&&(m(Ht,Ar[v-2].l,!1,!1),c(Ht,!0,!1,16*x-kr,16*h-Mr-5,16,21)));for(x=0;yr/10>x;x++)for(h=0;xr/10>h;h++)b=gt(Er,x,h,"N"),k=gt(Er,x,h,"E"),M=gt(Er,x,h,"S"),F=gt(Er,x,h,"W"),b&&s(b,x,h),k&&s(k,x,h),M&&s(M,x,h),F&&s(F,x,h);e(n,t,r,i,1),e(n,t,r,i,4),o(n,t,r,i,2),o(n,t,r,i,8)}function e(n,t,r,e,o){var i,a,h,l,d,u,f,y,x,s,m,c,p,w;for(i=n;r>i;i++)for(a=0,h=16*-rr*2,l=0,d=0,u=t;e>u;u++)f=fr[W(i+1,u-1,rr)],y=fr[W(i,u-1,rr)],x=fr[W(i-1,u-1,rr)],1===o?(d=fr[W(i-1,u,rr)],0>i-1&&(d=-1)):4===o&&(d=fr[W(i+1,u,rr)],i+1>rr-1&&(d=-1)),0!==fr[W(i,u,rr)]&&9!==fr[W(i,u,rr)]&&1>d&&(a+=16,h===16*-rr*2&&(0===y&&(l=1),h=16*u-Mr)),(0===fr[W(i,u,rr)]||9===fr[W(i,u,rr)]||u===e-1||d>0)&&(s=h,m=16*i-kr,c=s+a,p=16*(i+1)-kr,w=m,4===o&&(w=p),l&&(s-=5),(4===o&&0===f||1===o&&0===x)&&d>0?g(Pt,!1,!0,w,s,w,c+3):g(Pt,!1,!0,w,s,w,c)),(0===fr[W(i,u,rr)]||9===fr[W(i,u,rr)]||u===e-1||d>0)&&(a=0,h=16*-rr*2,l=0)}function o(n,t,r,e,o){var i,a,h,l,d,u,f,y,x,s;for(i=t;e>i;i++)for(a=0,h=16*-rr*2,l=0,d=0,u=n;r>u;u++)2===o?0>i-1?d=-1:(d=fr[W(u,i-1,rr)],l=1):8===o&&(d=fr[W(u,i+1,rr)],i+1>rr-1&&(d=-1)),0!==fr[W(u,i,rr)]&&9!==fr[W(u,i,rr)]&&1>d&&(a+=16,h===16*-rr*2&&(h=16*u-kr)),(0===fr[W(u,i,rr)]||9===fr[W(u,i,rr)]||u===r-1||d>0)&&(f=h,y=16*i-Mr,x=f+a,s=16*(i+1)-Mr,2===o?1===l?(g(Pt,!1,!0,f,y-5,x,y-5),g(Pt,!1,!0,f,y+3,x,y+3)):g(Pt,!1,!0,f,s,x,s):8===o&&g(Pt,!1,!0,f,s,x,s)),(0===fr[W(u,i,rr)]||9===fr[W(u,i,rr)]||u===r-1||d>0)&&(a=0,h=16*-rr*2,l=0)}function i(){var n,t,r,e,o;for(Tt.width=Or,Tt.height=Or,rt(),Nr=16*Er.x+16*E(E(E(Gr.x),10),1),Ir=16*Er.y+16*E(E(E(Gr.y),10),1),Dt.clearRect(0,0,Tt.width,Tt.height),Lr.length=0,m(Dt,"#000",!1,2),n=0;n<Cr.r.length;n++)for(t=0;t<Cr.r[n].rooms.length;t++)r=Cr.r[n].rooms[t],e=16*r.x-Fr,o=16*r.y-jr,e+16*r.mw>0&&o+16*r.mh>0&&e<Tt.width&&o<Tt.height&&c(Dt,!0,!1,e,o,16*r.mw,16*r.mh);a("bg","bd",function(n,t,r){n.v&&c(Dt,!0,!0,t,r,16*n.mw,16*n.mh)},Dt),a("bd",0,function(n,t,r){n.r.u&&!n.v&&c(Dt,!0,!1,t,r,16*n.mw,16*n.mh)},Dt),a(0,"bg",d,Dt),a(0,0,h,Dt),f()}function a(n,t,r,e){var o,i,a,h,l,d=e||Dt;for(o=0;o<Cr.r.length;o++)for(m(d,Cr.r[o].color[n]||"rgba(0,0,0,0)",Cr.r[o].color[t]||"rgba(0,0,0,0)",!1),i=0;i<Cr.r[o].rooms.length;i++)a=Cr.r[o].rooms[i],h=16*a.x-Fr,l=16*a.y-jr,h+16*a.mw>0&&l+16*a.mh>0&&h<Tt.width&&l<Tt.height&&r(a,h,l,d)}function h(n){var t,r,e,o,i,a;if(n.v){for(t=null,r=null,e=null,o=0;o<n.d.length;o++)t=n.d[o],t.dt>-1&&(i=0,a=0,"N"===t.dir&&(i=5),"S"===t.dir&&(i=5,a=16),"W"===t.dir&&(i=-3,a=8),"E"===t.dir&&(i=13,a=8),m(Dt,Ar[t.dt].l,Ar[t.dt].bd,2),l(Dt,16*t.x+i-Fr,16*t.y+a-jr,3,!0));n.s>-1&&(m(Dt,Ar[n.s].bd,Ar[n.s].l,2),l(Dt,16*(n.x+n.mw/2)-3-Fr,16*(n.y+n.mh/2)-jr,3,!0))}}function l(n,t,r,e,o){n.beginPath(),n.arc(t+e,r,e,0,2*Math.PI,!1),n.fill(),o&&n.stroke(),n.closePath()}function d(n){var t,r,e,o,i,a;if(n.v)for(t=null,r=0;r<n.d.length;r++)t=n.d[r],e=n.x+"-"+n.y+"-"+t.r2.x+"-"+t.r2.y,o=t.r2.x+"-"+t.r2.y+"-"+n.x+"-"+n.y,-1===Lr.indexOf(o)&&-1===Lr.indexOf(e)&&(i=16*t.x-Fr,a=16*t.y-jr,"N"===t.dir&&g(Dt,!0,!0,i+4,a,i+16-4,a),"S"===t.dir&&g(Dt,!0,!0,i+4,16*(t.y+1)-jr,i+16-4,16*(t.y+1)-jr),"W"===t.dir&&g(Dt,!0,!0,i,a+4,i,a+16-4),"E"===t.dir&&g(Dt,!0,!0,16*(t.x+1)-Fr,a+4,16*(t.x+1)-Fr,a+16-4),Lr.push(e))}function u(){for(var n=0;n<Gr.keys.length;n++)m(Rt,Ar[Gr.keys[n]].l,!1,!1),c(Rt,!0,!1,Gr.x-kr+1,Gr.y-Mr+(4-n)*Gr.h/5,Gr.w-2,Gr.h/5-1)}function f(){var n,t,r,e;for(n=0;n<Kr.length;n++)t=Kr[n],r=(15-15*(Gr.ῼ/Gr.mῼ)).toString(16),m(Rt,"rgba(0,0,0,0.1)","#"+r+r+"0000",1),c(Rt,!0,!0,t.x-kr,t.y-Mr,t.w,t.h),u();Br+=2*(Jr/1e3),Br%=2,e=1,Br>1&&(e=0),Hr!==e&&m(zt,"rgba(255,255,0,"+.6*e+")","rgba(255,255,0,"+.8*e+")",!1),Xt.width!==Tt.width&&(Xt.width=Tt.width,Xt.height=Tt.height,m(zt,"rgba(255,255,0,"+.6*e+")","rgba(255,255,0,"+.8*e+")",!1)),Rr||(m(zt,!1,!1,1),Rr=!0),zt.clearRect(0,0,Xt.width,Xt.height),c(zt,!0,!0,Nr-Fr,Ir-jr,16,16),Hr=e}function y(){Gr.keys.length>0&&(m(Rt,Ar[Gr.keys[tr]].l,"#000000",!1),p(Rt,Gr.x-kr+Gr.w/2,Gr.y-Mr+Gr.h/2,Jt,function(){g(Rt,!0,!0,10+Gr.w,0,0+Gr.w,-10,0+Gr.w,10,10+Gr.w,0)}))}function x(){var n,t;for(n=0;n<Kt.length;n++)t=Kt[n],m(Rt,Ar[t.key].l,Ar[t.key].bd,1),p(Rt,t.x-kr,t.y-Mr,t.a,function(){c(Rt,!0,!0,0,0,10,2)})}function s(n,t,r){var e,o,i="#FFFFFF",a="#000000";n.dt>-1&&(a=Ar[n.dt].l),m(Ht,a,i,!1),e=160,o=80,"N"===n.dir&&(e=o,o=0),"W"===n.dir&&(e=0),"S"===n.dir&&(e=o,o=160),p(Ht,16*t*10-kr+e,16*r*10-Mr+o,!1,function(){"N"===n.dir&&g(Ht,!0,!0,0,-20,10,-10,-10,-10,0,-20),"W"===n.dir&&g(Ht,!0,!0,-20,0,-10,-10,-10,10,-20,0),"S"===n.dir&&g(Ht,!0,!0,0,20,10,10,-10,10,0,20),"E"===n.dir&&g(Ht,!0,!0,20,0,10,-10,10,10,20,0)})}function m(n,t,r,e){t!==!1&&(n.fillStyle=t),r!==!1&&(n.strokeStyle=r),e!==!1&&(n.lineWidth=e)}function c(n,t,r,e,o,i,a){n.beginPath(),n.rect(e,o,i,a),t&&n.fill(),r&&n.stroke(),n.closePath()}function g(n,t,r,e,o){n.beginPath(),n.moveTo(e,o);for(var i=3;i<arguments.length;i+=2)n.lineTo(arguments[i],arguments[i+1]);t&&n.fill(),r&&n.stroke(),n.closePath()}function p(n,t,r,e,o){n.save(),n.translate(t,r),e!==!1&&n.rotate(e),o(),n.restore()}function w(n,t){Yr[n]||(Yr[n]=[]),Yr[n].push(t)}function v(n){var t,r=n.type;if(Yr[r]&&Yr[r].length>0)for(t=0;t<Yr[r].length;t++)Yr[r][t](n)}function b(n){return t.getElementById(n)}function k(){var n,t,r,e,o,i,a,h;for(Yt=b("clr"),It=b("p"),Bt=b("b"),Lt=b("t"),Tt=b("m"),Xt=b("i"),Rt=It.getContext("2d"),Pt=Bt.getContext("2d"),Ht=Lt.getContext("2d"),Dt=Tt.getContext("2d"),zt=Xt.getContext("2d"),M(),At(),n=null,t=0;t<Ar.length;t++){for(r=C(5,10),e=0;r>e;e++)wt();t+1<Ar.length&&(n=Cr.r[Cr.r.length-1],ot(Ot(),n))}for(ot(Ot(),Cr.r[0]),r=C(5,10),e=0;r>e;e++)wt();o=Cr.r[0].rooms[0],i=o.d[0],a=i.dir,h=i.x,o.sr=!0,o.sx=h-o.x,o.sy=i.y-o.y,("E"===i.dir||"W"===i.dir)&&(h=i.y),jt(),Ct(),nt(o,a,h),j()}function M(){Bt.width=It.width=Lt.width=n.innerWidth>300?300:n.innerWidth,Bt.height=It.height=Lt.height=n.innerHeight>300?300:n.innerHeight}function F(){var n,t;if(Pr){for(n=0;n<Kr.length;n++)t=Kr[n],T(t),t.x=A(t.x),t.y=A(t.y),q(t),Y(t),z(t),$(),X(t);for(R(),P(),n=0;n<Kt.length;n++)J(Kt[n]);Rt.clearRect(0,0,It.width,It.height),Pt.clearRect(0,0,Bt.width,Bt.height),r(),i(),y(),x()}}function j(){zr=n.performance.now(),Jr=zr-Xr,Xr=zr,t.dispatchEvent(Tr),Dr&&requestAnimationFrame(j)}function C(n,t){return Math.floor(Math.random()*(t-n+1)+n)}function E(n,t){var r=n%(t||16);return(n-r)/(t||16)}function W(n,t,r){return t*r+n}function S(n,t){var r,e,o;if("object"==typeof t){for(r=0;r<n.length;r++)if(e=!0,"object"==typeof n[r]){for(o in t)if(n[r][o]!==t[o]){e=!1;break}if(e===!0)return r}return-1}return n.indexOf(t)}function A(n){return~~(.5+n)}function O(t){for(var r in Qr)Qr[r]===t.keyCode&&t.preventDefault();qr[t.keyCode]!==t.type&&(t.keyCode===Qr.space&&(Gr.j=1),t.keyCode===Qr.tab&&(Or=Math.min(16*E(n.innerHeight),16*E(n.innerWidth)))),qr[t.keyCode]=t.type,t.keyCode===Qr.d?Gr.xd=1:t.keyCode===Qr.a&&(Gr.xd=-1)}function N(n){for(var t in Qr)Qr[t]===n.keyCode&&n.preventDefault();qr[n.keyCode]!==n.type&&n.keyCode===Qr.space&&(Gr.j=0),qr[n.keyCode]=n.type,n.keyCode===Qr.tab&&(Or=150),(n.keyCode===Qr.d||n.keyCode===Qr.a)&&(qr[Qr.d]&&qr[Qr.a]?qr[Qr.d]===n.type&&qr[Qr.a]===n.type&&(Gr.xd=0):Gr.xd=0)}function I(n){var t=It.getBoundingClientRect();_t=n.clientX-t.left,nr=n.clientY-t.top,qt=n.clientX,Gt=n.clientY,Jt=Math.atan2(Gr.y+Gr.h/2-Mr-nr,Gr.x+Gr.w/2-kr-_t)+Math.PI}function L(n){n.preventDefault(),1===n.which&&(Ut=!0),2===n.which&&(tr++,tr>Gr.keys.length-1&&(tr=0)),3===n.which&&(Vt=!0)}function B(n){n.preventDefault(),1===n.which&&(Ut=!1),3===n.which&&(Vt=!1)}function R(){Ut&&n.performance.now()-Qt>Zt&&Gr.keys.length>0&&(Qt=n.performance.now(),Kt.push(D(Gr.x+Gr.w/2+10*Math.cos(Jt),Gr.y+Gr.h/2+10*Math.sin(Jt),Jt,Gr.keys[tr])))}function H(n){n.preventDefault()}function P(){var n,t,r;Vt&&(n=_t+kr,t=nr+Mr,n>=0&&16*yr>n&&t>=0&&16*xr>t&&(r=W(E(n),E(t),rr),0===fr[r]&&$t[Gr.keys[tr]]>0&&(fr[r]=Gr.keys[tr]+2,$t[Gr.keys[tr]]--)))}function D(n,t,r,e){return{x:n,y:t,a:r,key:e}}function T(n){n.xa=n.xa+n.xd/60*Jr,n.xa>n.maxa&&(n.xa=n.maxa),n.xa<-n.maxa&&(n.xa=-n.maxa),0===n.xd&&(n.xa>0?n.xa=n.xa+-2/60*Jr:n.xa<0&&(n.xa=n.xa+2/60*Jr),(n.xa<1/60*Jr&&n.xa>-1/60*Jr||1===n.yd||-1===n.yd)&&(n.xa=0)),n.x=n.x+n.xa}function z(n){n.j&&-1!==n.yd&&n.ju<n.mj&&(n.mj>1&&0===n.ju&&1===n.yd&&n.ju++,(0===n.ju&&0===n.yd||n.ju>0||n.mj>1)&&(n.yd=-1,n.ya=-n.jf,n.js=n.y,n.ju++),n.ht=0),(0===n.yd||!n.j||n.ht>n.jh)&&(n.yd=1),1===n.yd&&(n.j=0,n.ya=n.ya+n.jf/2/60*Jr),0===n.yd&&(n.ya>0?n.ya=n.ya+-1/60*Jr:n.ya<0&&(n.ya=n.ya+1/60*Jr),n.ya<1/60*Jr&&n.ya>-1/60*Jr&&(n.ya=0)),n.ya>n.maxa&&(n.ya=10),n.ht-=n.ya,n.ht=A(n.ht),n.y=n.y+n.ya}function X(n){var t=n.x%16,r=W(E(n.x),E(n.y+n.h),rr),e=W(E(n.x+n.w),E(n.y+n.h),rr),o=!1;o=0===t?G(fr[r]):G(fr[e])||G(fr[r]),(o||n.y+n.h>16*xr)&&1===n.yd&&(n.y=16*E(n.y),n.ya=0,n.yd=0,n.ju=0,n.j=0,n.ht=0)}function Y(n){var t=n.x%16,r=W(E(n.x),E(n.y-n.h/2),rr),e=W(E(n.x+n.w),E(n.y-n.h/2),rr),o=!1;o=0===t?G(fr[r]):G(fr[r])||G(fr[e]),o&&1===n.j&&(n.y=16*E(n.y),n.ya=-1,n.yd=1,n.j=0,n.ht=0)}function q(n){var t=n.y%16,r=n.x%16,e=W(E(n.x),E(n.y-n.h/2),rr),o=W(E(n.x+n.w),E(n.y-n.h/2),rr),i=W(E(n.x),E(n.y),rr),a=W(E(n.x+n.w),E(n.y),rr),h=W(E(n.x),E(n.y+n.h/2),rr),l=W(E(n.x+n.w),E(n.y+n.h/2),rr),d=W(E(n.x),E(n.y+n.h),rr),u=W(E(n.x+n.w),E(n.y+n.h),rr),f=!1,y=!1;0===t?(f=G(fr[h])||G(fr[i]),y=G(fr[l])||G(fr[a])):16*E(n.y+n.h)>n.y+n.h?(f=G(fr[h])||G(fr[i])||G(fr[e]),y=G(fr[l])||G(fr[a])||G(fr[o])):(f=G(fr[h])||G(fr[i])||G(fr[d]),y=G(fr[l])||G(fr[a])||G(fr[u])),0===r?(y||n.x+n.w>16*yr||n.x<0)&&n.xa>0&&(n.x=16*E(n.x),n.xa=0):(y||n.x+n.w>16*yr||n.x<0)&&n.xa>0?(n.x=16*E(n.x),n.xa=0):(f||n.x+n.w>16*yr||n.x<0)&&n.xa<0&&(n.x=16*E(n.x+n.w),n.xa=0)}function G(n){return 9===n&&Et(Er),0!==n}function J(n){var t,r,e,o,i=!1;n.x+=Math.cos(n.a)*(10/60)*Jr,n.y+=Math.sin(n.a)*(10/60)*Jr,t=E(n.x),r=E(n.y),e=W(t,r,rr),0!==fr[e]&&(fr[e]>1&&Gr.keys[tr]===fr[e]-2&&($t[fr[e]-2]++,fr[e]=0),i=!0),(n.x>16*yr||n.x<0||n.y>16*xr||n.y<0)&&(i=!0),i&&(o=Kt.indexOf(n),o>-1&&Kt.splice(o,1))}function K(n,t){t=t.split("");for(var r=0;r<t.length;r++)t[r]=parseInt(t[r]);return{map:t,type:n}}function Q(n){return{map:n.map.slice(0),type:n.type}}function U(n,t,r,e){var o,i,a,h,l,d,u,f,y,x,s,m,c,g,p,w,v,b,k,M,F=[],j=[],E=Math.max(n,t);for(o=0;E*E>o;o++)F[o]=0;for(F=e(F,n,t,E),a={},f=0;10*E>f;f++)for(y=0;10*E>y;y++)x=Math.floor(y/10),s=Math.floor(f/10),h=gt(r,x,s,"N"),l=gt(r,x,s,"E"),d=gt(r,x,s,"S"),u=gt(r,x,s,"W"),m=W(x,s,E),c=x+"-"+s,(y%10===0||f%10===0)&&(a[c]||(i=Q(hr[F[m]]),a[c]=i),i=a[c]),g=W(y,f,10*E),p=W(y%10,f%10,10),w=10*n>y&&10*t>f&&10*n>y&&10*t>f,j[g]=r.r.u&&0===r.r.id&&0!==i.map[p]&&w?1===C(0,5)?C(0,Ar.length-1)+2:0:i.map[p],r.r.u&&0===j[g]&&9!==i.type&&w&&((1===r.r.id||2===r.r.id||3===r.r.id)&&(j[g]=r.r.id+2),C(0,6)<2&&2===r.r.id&&(j[g]=0),C(0,6)<4&&3===r.r.id&&(j[g]=0),1===C(0,3)&&4===r.r.id&&(j[g]=r.r.id+2),1===C(0,3)&&0===r.r.id&&(j[g]=r.r.id+2)),r.r.u&&2!==r.r.id&&1!==r.r.id&&1===j[g]&&9!==i.type&&w&&(1===C(0,3)?j[g]=r.r.id+2:2===C(0,3)&&(j[g]=0)),v=10*t,b=10*n,k=y%10,M=f%10,0===f&&null===h&&b>y&&(j[g]=1),0===y&&null===u&&v>f&&(j[g]=1),f===v-1&&null===d&&b>y&&(j[g]=1),y===b-1&&null===l&&v>f&&(j[g]=1),y>-1&&2>y&&f>-1&&2>f&&(j[g]=1),y>7&&10>y&&f>-1&&2>f&&(j[g]=1),y>-1&&2>y&&f>7&&10>f&&(j[g]=1),y>7&&10>y&&f>7&&10>f&&(j[g]=1),0===j[g]&&w&&(0===f&&null!==h&&b>y&&h.dt>-1&&(j[g]=h.dt+2),0===y&&null!==u&&v>f&&u.dt>-1&&(j[g]=u.dt+2),f===v-1&&null!==d&&b>y&&d.dt>-1&&(j[g]=d.dt+2),y===b-1&&null!==l&&v>f&&l.dt>-1&&(j[g]=l.dt+2));return{map:j,width:n,height:t,size:E,tiles:10*E}}function V(n){var t,r,e,o,i,a,h,l;if(n.map=U(1*n.mw,1*n.mh,n,function(t,r,e,o){var i,a,h,l,d,u,f,y=0,x=0,s=0;for(i=0;o*o>i;i++)a=gt(n,y,x,"N"),h=gt(n,y,x,"E"),l=gt(n,y,x,"S"),d=gt(n,y,x,"W"),u=[1,3,4,9],f=[2,9,10,11],(0===y||0===x||y===r-1||x===e-1)&&(s=C(0,11)),(0===y||y===r-1)&&(s=f[C(0,3)]),(0===x||x===e-1)&&(s=u[C(0,3)]),(0===y&&0===x||y===r-1&&0===x||y===r-1&&x===e-1||0===y&&x===e-1)&&(s=9),1===n.mw&&(s=f[C(0,3)]),1===n.mh&&(s=u[C(0,3)]),0===y&&0===x&&(s=6),y===r-1&&0===x&&(s=7),0===y&&x===e-1&&(s=5),y===r-1&&x===e-1&&(s=8),(a||l||h||d)&&(s=9),t[W(y,x,o)]=s,y++,y>r-1&&(y=0,x++),x>e-1&&(i=o*o);return t}),n.s>-1&&-1===Gr.keys.indexOf(n.s))for(t=0,r=!1;r===!1&&5>t;)n.sr?(e=1*n.sx,o=1*n.sy):(e=C(1,1*n.mw)-1,o=C(1,1*n.mh)-1),i=C(1,9),a=C(1,9),h=W(10*e+a,10*o+i,n.map.tiles),l=0===n.map.map[h]||n.map.map[h]===n.r.id+2,l&&(r=!0,n.map.map[W(10*e+a,10*o+i,n.map.tiles)]=9),t++}function Z(n,t,r){var e,o,i,a,h;for(e=0;e<n.d.length;e++)o=!1,i=n.d[e],i.dir===t&&(("N"===i.dir||"S"===i.dir)&&(o=r===i.x),("E"===i.dir||"W"===i.dir)&&(o=r===i.y),o&&(a=1*(i.x-n.x),h=1*(i.y-n.y),-1===Gr.y&&(Gr.y=10*h*16+80),-1===Gr.x&&(Gr.x=10*a*16+80),"N"===i.dir&&(a+=Math.floor(.5),Gr.y=0,i.dt>-1&&(Gr.y=16),Gr.x=Gr.x%160+10*a*16),"E"===i.dir&&(h+=Math.floor(.5),a+=1,Gr.x=10*n.mw*16*1-Gr.w,i.dt>-1&&(Gr.x-=16),Gr.y=Gr.y%160+10*h*16),"S"===i.dir&&(a+=Math.floor(.5),h+=1,Gr.y=10*n.mh*16*1-Gr.h,i.dt>-1&&(Gr.y-=16),Gr.x=Gr.x%160+10*a*16),"W"===i.dir&&(h+=Math.floor(.5),Gr.x=0,i.dt>-1&&(Gr.x=16),Gr.y=Gr.y%160+10*h*16)))}function $(){var t,r,e,o,i,a,h,l,d,u;for(t=0;t<Er.d.length;t++)r=Er.d[t],e=1*(r.x-Er.x),o=1*(r.y-Er.y),i=E(E(Gr.x),10),a=E(E(Gr.x+Gr.w),10),h=E(E(Gr.y),10),l=E(E(Gr.y+Gr.h),10),d=10*Er.mw*16*1,u=10*Er.mh*16*1,"N"===r.dir&&(e+=Math.floor(.5)),"E"===r.dir&&(o+=Math.floor(.5),e+=1),"S"===r.dir&&(e+=Math.floor(.5),o+=1),"W"===r.dir&&(o+=Math.floor(.5)),n.performance.now()-Gr.dc>400&&(Gr.x<=0&&-1===Gr.xd&&"W"===r.dir&&e===i&&o===h&&nt(r.r2,"E",r.y),Gr.y<=0&&-1===Gr.yd&&"N"===r.dir&&e===i&&o===h&&nt(r.r2,"S",r.x),Gr.x+Gr.w>=d&&1===Gr.xd&&"E"===r.dir&&e===a&&o===h&&nt(r.r2,"W",r.y),Gr.y+Gr.h>=u&&0!==Gr.yd&&Math.abs(Gr.ya)>5&&"S"===r.dir&&e===i&&(o===l||o===h)&&nt(r.r2,"N",r.x))}function _(){var e,o,a,h,l,d;gr&&(null===Er&&(vr=br),e=It.width,o=It.height,a=e,h=o,br>vr&&(a=e*vr/br,a=e-a,h=o*vr/br,h=o-h),vr>=br&&(Er!==cr&&(Pt.clearRect(0,0,e,o),Ht.clearRect(0,0,e,o),Er=cr,Er.v=!0,rr=cr.map.tiles,fr=cr.map.map,xr=10*cr.map.height,yr=10*cr.map.width,er=10*cr.map.height*16,or=10*cr.map.width*16,Z(cr,sr,mr),t.title=Er.c.name,history.pushState(null,null,"#"+t.title),Kt.length=0),a=e*(vr-br)/br,h=o*(vr-br)/br),pr.width=e,pr.height=o,wr.clearRect(0,0,e,o),i(),r(),wr.drawImage(Lt,0,0),wr.drawImage(Bt,0,0),wr.drawImage(It,0,0),Rt.clearRect(0,0,e,o),Bt.style.display="none",Lt.style.display="none",wr.globalCompositeOperation="destination-in",l=Gr.x+Gr.w/2-kr-a/2,d=Gr.y+Gr.h/2-Mr-h/2,wr.beginPath(),wr.rect(l,d,a,h),wr.fillStyle="black",wr.fill(),Rt.drawImage(pr,0,0),vr+=2*br*(Jr/1e3),vr>2*br&&(vr=0,Pr=!0,cr=null,gr=!1,Bt.style.display="initial",Lt.style.display="initial",Gr.dc=n.performance.now()))}function nt(n,t,r){sr=t,mr=r,gr=!0,cr=n,Pr=!1,null===n.map&&V(n)}function tt(){var n=Ht.canvas,t=n.width/2,r=n.height/2;Gr.x-kr+t>n.width?kr=Gr.x-(n.width-t):Gr.x-t<kr&&(kr=Gr.x-t),Gr.y-Mr+r>n.height?Mr=Gr.y-(n.height-r):Gr.y-r<Mr&&(Mr=Gr.y-r),Mr=~~(.5+Mr),Mr=~~(.5+Mr)}function rt(){var n=Dt.canvas,t=n.width/2,r=n.height/2,e=16*(Er.x+E(E(E(Gr.x),10),1)),o=16*(Er.y+E(E(E(Gr.y),10),1));e-Fr+t>n.width?Fr=e-(n.width-t):Fr>e-t&&(Fr=e-t),o-jr+r>n.height?jr=o-(n.height-r):jr>o-r&&(jr=o-r),jr=~~(.5+jr),jr=~~(.5+jr)}function et(n,t,r){Cr.f.length=0,Cr.f.push({x:n,y:t}),Cr.cr=r,Cr.r.push(r)}function ot(n,t){for(var r,e,o=!0,i=at(t),a=[],h=null,l=[];o;){if(r=0,h=it(i,l),a.length=0,h)for(a.push(ct(h.x-1,h.y),ct(h.x+1,h.y),ct(h.x,h.y-1),ct(h.x,h.y+1)),e=0;4>e;e++)null===a[e]&&r++;else o=!1;r>2&&(o=!1)}h&&et(h.x,h.y,n)}function it(n,t){if(t.length===n.length)return!1;for(var r=C(0,n.length-1);t.indexOf(r)>-1;)r=C(0,n.length-1);return t.push(r),n[r]}function at(n){var t,r=[],e=Cr.rooms;for(n&&(e=n.rooms),t=0;t<e.length;t++)r=ht(r,e[t]);return r}function ht(n,t){for(var r,e=t.x;e<t.x+t.mw;)lt(e,t.y-1,1,1)&&n.push({x:e,y:t.y-1}),lt(e,t.y+t.mh,1,1)&&n.push({x:e,y:t.y+t.mh}),e++;for(r=t.x;r<t.y+t.mh;)lt(r,t.x-1,1,1)&&n.push({x:r,y:t.x-1}),lt(r,t.x+t.mw,1,1)&&n.push({x:r,y:t.x+t.mw}),r++;return n}function lt(n,t,r,e){return dt(n,t,r,e)&&!ut(n,t,r,e)}function dt(n,t,r,e){return n>0&&t>0&&n+r<Cr.width&&t+e<Cr.height}function ut(n,t,r,e){for(var o=null,i=0;i<Cr.rooms.length;){o=Cr.rooms[i];{if(!(o.x>n+r-1||o.x+o.mw-1<n||o.y>t+e-1||o.y+o.mh-1<t))return!0;i++}}return!1}function ft(n){for(var t,r,e,o=0,i=null,a=!1,h=100;Cr.rooms.length>1&&!a;){for(o=0,o+=yt(n),o+=xt(n),o+=st(n),o+=mt(n),1===n.r.rooms.length&&o>0&&(a=!0),t=0;t<n.d.length;t++)i=n.d[t],St(i,n).r===n.r&&(a=!0);h--,0===h&&(a=!0)}for(t=0;t<n.d.length;t++)r=n.r,e=St(i,n).r,r!==e&&(-1===r.bds.indexOf(e)&&r.bds.push(e),-1===e.bds.indexOf(r)&&e.bds.push(r))}function yt(n){for(var t,r,e,o,i=null,a=null,h=null,l=null,d=[],u=n.x;u<n.x+n.mw;)a=ct(u,n.y-1),null!==a&&d.push({x:u,y:n.y,o:a}),u++;for(t=0,r=0;r<d.length;r++){for(i=d[r],e=!1,o=0;o<n.d.length;o++)n.d[o].r2===i.o&&(e=!0);Math.random()>Wr||S(n.d,i)>=0||e||(h=Ft(i.x,i.y,"N",n,i.o),l=Ft(i.x,i.y-1,"S",i.o,n),n.d.push(h),h.o=l,l.o=h,i.o.d.push(l),t++)}return t}function xt(n){for(var t,r,e,o,i=null,a=null,h=null,l=null,d=[],u=n.x;u<n.x+n.mw;)a=ct(u,n.y+n.mh),null!==a&&d.push({x:u,y:n.y+n.mh-1,o:a}),u++;for(t=0,r=0;r<d.length;r++){for(i=d[r],e=!1,o=0;o<n.d.length;o++)n.d[o].r2===i.o&&(e=!0);Math.random()>Wr||S(n.d,i)>=0||e||(h=Ft(i.x,i.y,"S",n,i.o),l=Ft(i.x,i.y+1,"N",i.o,n),n.d.push(h),h.o=l,l.o=h,i.o.d.push(l),t++)}return t}function st(n){for(var t,r,e,o,i=null,a=null,h=null,l=null,d=[],u=n.y;u<n.y+n.mh;)a=ct(n.x-1,u),null!==a&&d.push({x:n.x,y:u,o:a}),u++;for(t=0,r=0;r<d.length;r++){for(i=d[r],e=!1,o=0;o<n.d.length;o++)n.d[o].r2===i.o&&(e=!0);Math.random()>Wr||S(n.d,i)>=0||e||(h=Ft(i.x,i.y,"W",n,i.o),l=Ft(i.x-1,i.y,"E",i.o,n),n.d.push(h),h.o=l,l.o=h,i.o.d.push(l),t++)}return t}function mt(n){for(var t,r,e,o,i=null,a=null,h=null,l=null,d=[],u=n.y;u<n.y+n.mh;)a=ct(n.x+n.mw,u),null!==a&&d.push({x:n.x+n.mw-1,y:u,o:a}),u++;for(t=0,r=0;r<d.length;r++){for(i=d[r],e=!1,o=0;o<n.d.length;o++)n.d[o].r2===i.o&&(e=!0);Math.random()>Wr||S(n.d,i)>=0||e||(h=Ft(i.x,i.y,"E",n,i.o),l=Ft(i.x+1,i.y,"W",i.o,n),h.o=l,l.o=h,n.d.push(h),i.o.d.push(l),t++)}return t}function ct(n,t){for(var r=null,e=0;e<Cr.rooms.length;){r=Cr.rooms[e];{if(!(r.x>n||r.x+r.mw-1<n||r.y>t||r.y+r.mh-1<t))return r;e++}}return null}function gt(n,t,r,e){var o,i=null;for(o=0;o<n.d.length;o++)if(i=n.d[o],i.dir===e&&i.x===n.x+t&&i.y===n.y+r)return i;return null}function pt(n){for(var t=0,r=Cr.rooms.length;t++<10*n&&Cr.rooms.length<r+n;)wt()}function wt(){var n=[],t=it(Cr.f,n);t&&vt(kt(t.x,t.y))}function vt(n){if(null===n||!lt(n.x,n.y,n.mw,n.mh))return!1;var t=[];t=bt(t,n),Cr.f=ht(t,n),n.c=Cr.cr.color,Cr.rooms.push(n),Cr.cr.rooms.push(n),ft(n)}function ht(n,t){for(var r,e=t.x;e<t.x+t.mw;)lt(e,t.y-1,1,1)&&n.push({x:e,y:t.y-1}),lt(e,t.y+t.mh,1,1)&&n.push({x:e,y:t.y+t.mh}),e++;for(r=t.y;r<t.y+t.mh;)lt(t.x-1,r,1,1)&&n.push({x:t.x-1,y:r}),lt(t.x+t.mw,r,1,1)&&n.push({x:t.x+t.mw,y:r}),r++;return n}function bt(n,t){for(var r=0;r<Cr.f.length;r++)Cr.f[r].x>=t.x-1&&Cr.f[r].x<=t.x+t.mw&&Cr.f[r].y>=t.y&&Cr.f[r].y<=t.y+t.mh-1||Cr.f[r].x>=t.x&&Cr.f[r].x<=t.x+t.mw-1&&Cr.f[r].y>=t.y-1&&Cr.f[r].y<=t.y+t.mh||n.push(Cr.f[r]);return n}function kt(n,t){for(var r,e=0,o=1,i=1;e++<25&&(o<Cr.cr.maxW||i<Cr.cr.maxH)&&Math.random()<.9;)r=parseInt(4*Math.random()),0===r&&i<Cr.cr.maxH&&lt(n,t-1,o,i+1)&&(t--,i++),1===r&&i<Cr.cr.maxH&&lt(n,t,o,i+1)&&i++,2===r&&o<Cr.cr.maxW&&lt(n-1,t,o+1,i)&&(n--,o++),3===r&&o<Cr.cr.maxW&&lt(n,t,o+1,i)&&o++;return Mt(n,t,o,i,Cr.cr)}function Mt(n,t,r,e,o){return{x:n,y:t,mw:r,mh:e,c:null,r:o,s:-1,sx:0,sy:0,sr:!1,v:!1,d:[],map:null}}function Ft(n,t,r,e,o){return{x:n,y:t,dt:-1,dir:r,r1:e,r2:o,o:null}}function jt(){var n,t,r=null,e=null;for(n=0;n<Cr.rooms.length;n++)for(r=Cr.rooms[n],r.s=-1,t=0;t<r.d.length;t++)e=r.d[t],e.dt=-1}function Ct(){var n,t,r,e,o=null,i=null,a=null,h=null;for(n=0;n<Cr.r.length;n++)for(t=[],i=Cr.r[n],0!==n&&(h=it(i.rooms,t),h.s=(n+1)%Ar.length),r=0;r<i.rooms.length;r++)for(h=i.rooms[r],0===n&&h.sr&&(h.s=(n+1)%Ar.length),e=0;e<h.d.length;e++)o=h.d[e],a=St(o,h).r,a!==i&&-1===o.o.dt&&(o.o.dt=n%Ar.length)}function Et(n){-1===Gr.keys.indexOf(n.s)&&n.s>-1&&(Gr.keys.push(n.s),Wt())}function Wt(){var n,t,r,e,o;for(Yt.innerHTML="find "+(5-Gr.keys.length)+" color circles",5-Gr.keys.length===0&&(Yt.innerHTML="find the exit"),n=0;n<Cr.r.length;n++)Gr.keys.indexOf(Cr.r[n].id)>-1&&(Cr.r[n].u=!0);for(t=0;t<Cr.rooms.length;t++)for(r=Cr.rooms[t],Gr.keys.indexOf(r.s)>-1&&(r.s=-1,null!==r.map&&(e=r.map.map.indexOf(9),e>-1&&(r.map.map[e]=0))),n=0;n<r.d.length;n++)o=r.d[n],Gr.keys.indexOf(o.dt)>-1&&(o.dt=-1)}function St(n,t){return n.r1===t?n.r2:n.r1}function At(){Cr={width:0,height:0,rooms:[],f:[],r:[],cr:0},Sr=0,Cr.width=80,Cr.height=48,et(40,24,Ot()),pt(1)}function Ot(){var n=Nt(Ar[Sr],parseInt(3*Math.random())+parseInt(3*Math.random())+1,parseInt(3*Math.random())+parseInt(3*Math.random())+1,Sr);return Sr=(Sr+1)%Ar.length,n}function Nt(n,t,r,e){return{color:n,maxW:t,maxH:r,id:e,u:!1,bds:[],rooms:[]}}var It,Lt,Bt,Rt,Ht,Pt,Dt,Tt,zt,Xt,Yt,qt,Gt,Jt,Kt,Qt,Ut,Vt,Zt,$t,_t,nr,tr,rr,er,or,ir,ar,hr,lr,dr,ur,fr,yr,xr,sr,mr,cr,gr,pr,wr,vr,br,kr,Mr,Fr,jr,Cr,Er,Wr,Sr,Ar,Or=150,Nr=0,Ir=0,Lr=[],Br=0,Rr=!1,Hr=0,Pr=!0,Dr=!0,Tr=new CustomEvent("frame"),zr=n.performance.now(),Xr=n.performance.now(),Yr={},qr={},Gr={x:-1,y:-1,w:16,h:32,img:null,xd:0,yd:1,xa:0,ya:0,maxa:5,jf:7,jh:50,js:0,j:0,ju:0,ht:0,mj:1,a:0,"ῼ":5,dc:n.performance.now(),"mῼ":5,keys:[]},Jr=zr-Xr,Kr=[Gr],Qr={a:65,w:87,s:83,d:68,space:32,shift:16,ctrl:17,alt:18,tab:9,debug:192};for(w("keydown",O),w("keyup",N),w("resize",M),w("DOMContentLoaded",k),w("frame",F),w("frame",_),w("mousemove",I),w("mousedown",L),w("mouseup",B),w("contextmenu",H),n.addEventListener("resize",v),t.addEventListener("DOMContentLoaded",v),t.addEventListener("mousedown",v),t.addEventListener("mouseup",v),t.addEventListener("keydown",v),t.addEventListener("keyup",v),t.addEventListener("frame",v),t.addEventListener("mousemove",v),t.addEventListener("contextmenu",v),qt=0,Gt=0,Jt=0,Kt=[],Qt=n.performance.now(),Ut=!1,Vt=!1,Zt=150,$t=[0,0,0,0,0],_t=-1,nr=-1,tr=0,rr=0,er=0,or=0,ir=rr,ar=rr,hr=[],lr=[],dr=0;100>dr;dr++)lr[dr]=0;for(ur="1111111111111111111100000000000000000000000000000000000000000000000000000000000011111111111111111111,1100000011111000001111110000111100000011110000001111000000111100000111110000111111000000111100000011,1000000001110000001111100001110001001000000000000000000000000000000000000111100011111111111111111111,1111111111111000011100000000000000000000000011000000011110000000000000000000000011000000111100000111,1111000011110000001111000000111100000011110001111111000000001100000000110000000011111111111111111111,1111111111100000000010000000001000000000100000000010000000001000000000100000000010000011111000000011,1111111111000000000100000000010000000001000000000100000000010000000001000000000110000000011100000001,1111000011110000001111000000111100000011110001111100000111110000111111000011111111111111111111111111,1110000011110000000100000000000000000000000011000000001100000000000000000000000011000000111100000111,1100000011111000001100110000110000000011000000001100000000110000000111000000111111000000111100000011,1100000011111000001111110000001100000000110000000011000000001100000111110000111111000000111100000011".split(","),hr.push({map:lr,type:0}),dr=0;dr<ur.length;dr++)hr.push(K(dr+1,ur[dr]));fr=null,yr=0,xr=0,sr=0,mr=0,cr=null,gr=!1,pr=t.createElement("canvas"),wr=pr.getContext("2d"),vr=0,br=1,kr=0,Mr=0,Fr=0,jr=0,Cr=null,Er=null,Wr=.2,Sr=0,Ar=[{bg:"#BBBBBB",bd:"#A0A0A0",o:"#CFCFCF",l:"#FFFFFF",name:"Dungeon"},{bg:"#FF3333",bd:"#990000",o:"#FF0000",l:"#FFAAAA",name:"Fire"},{bg:"#00BB00",bd:"#006600",o:"#00BB00",l:"#AAFFAA",name:"Air"},{bg:"#3333FF",bd:"#000066",o:"#0000FF",l:"#AAAAFF",name:"Water"},{bg:"#9F9F9F",bd:"#555555",o:"#555555",l:"#000000",name:"Earth"}]}(window,document);