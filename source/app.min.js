!function(t,n){function e(t){t.xa=t.xa+t.xd/60*me,t.xa>t.maxa&&(t.xa=t.maxa),t.xa<-t.maxa&&(t.xa=-t.maxa),0===t.xd&&(t.xa>0?t.xa=t.xa+-2/60*me:t.xa<0&&(t.xa=t.xa+2/60*me),(t.xa<1/60*me&&t.xa>-1/60*me||1===t.yd||-1===t.yd)&&(t.xa=0)),t.x=t.x+t.xa}function r(t){t.j&&-1!==t.yd&&t.ju<t.mj&&(t.mj>1&&0===t.ju&&1===t.yd&&t.ju++,(0===t.ju&&0===t.yd||t.ju>0||t.mj>1)&&(t.yd=-1,t.ya=-t.jf,t.js=t.y,t.ju++),t.ht=0),(0===t.yd||!t.j||t.ht>t.jh)&&(t.yd=1),1===t.yd&&(t.j=0,t.ya=t.ya+t.jf/2/60*me),0===t.yd&&(t.ya>0?t.ya=t.ya+-1/60*me:t.ya<0&&(t.ya=t.ya+1/60*me),t.ya<1/60*me&&t.ya>-1/60*me&&(t.ya=0)),t.ya>t.maxa&&(t.ya=10),t.ht-=t.ya,t.ht=u(t.ht),t.y=t.y+t.ya}function o(t){var n=t.x%16,e=d(f(t.x),f(t.y+t.h),je),r=d(f(t.x+t.w),f(t.y+t.h),je),o=!1;o=0===n?i(Tn[e]):i(Tn[r])||i(Tn[e]),(o||t.y+t.h>16*qn)&&1===t.yd&&(t.y=16*f(t.y),t.ya=0,t.yd=0,t.ju=0,t.j=0,t.ht=0)}function a(t){var n=t.x%16,e=d(f(t.x),f(t.y-t.h/2),je),r=d(f(t.x+t.w),f(t.y-t.h/2),je),o=!1;o=0===n?i(Tn[e]):i(Tn[e])||i(Tn[r]),o&&1===t.j&&(t.y=16*f(t.y),t.ya=-1,t.yd=1,t.j=0,t.ht=0)}function l(t){var n=t.y%16,e=t.x%16,r=d(f(t.x),f(t.y-t.h/2),je),o=d(f(t.x+t.w),f(t.y-t.h/2),je),a=d(f(t.x),f(t.y),je),l=d(f(t.x+t.w),f(t.y),je),h=d(f(t.x),f(t.y+t.h/2),je),y=d(f(t.x+t.w),f(t.y+t.h/2),je),u=d(f(t.x),f(t.y+t.h),je),x=d(f(t.x+t.w),f(t.y+t.h),je),c=!1,m=!1;0===n?(c=i(Tn[h])||i(Tn[a]),m=i(Tn[y])||i(Tn[l])):16*f(t.y+t.h)>t.y+t.h?(c=i(Tn[h])||i(Tn[a])||i(Tn[r]),m=i(Tn[y])||i(Tn[l])||i(Tn[o])):(c=i(Tn[h])||i(Tn[a])||i(Tn[u]),m=i(Tn[y])||i(Tn[l])||i(Tn[x])),0===e?(m||t.x+t.w>16*zn||t.x<0)&&t.xa>0&&(t.x=16*f(t.x),t.xa=0):(m||t.x+t.w>16*zn||t.x<0)&&t.xa>0?(t.x=16*f(t.x),t.xa=0):(c||t.x+t.w>16*zn||t.x<0)&&t.xa<0&&(t.x=16*f(t.x+t.w),t.xa=0)}function i(t){return 9===t&&D(we),0!==t}function h(t,n){return Math.floor(Math.random()*(n-t+1)+t)}function f(t,n){var e=t%(n||16);return(t-e)/(n||16)}function d(t,n,e){return n*e+t}function y(t,n){var e,r,o;if("object"==typeof n){for(e=0;e<t.length;e++)if(r=!0,"object"==typeof t[e]){for(o in n)if(t[e][o]!==n[o]){r=!1;break}if(r===!0)return e}return-1}return t.indexOf(n)}function u(t){return~~(.5+t)}function x(t,n,e){pe.f.length=0,pe.f.push({x:t,y:n}),pe.cr=e,pe.r.push(e)}function c(t){for(var n,e,r=!0,o=s(),a=[],l=null;r;){for(n=0,l=m(o),a.length=0,a.push(M(l.x-1,l.y),M(l.x+1,l.y),M(l.x,l.y-1),M(l.x,l.y+1)),e=0;4>e;e++)null===a[e]&&n++;n>2&&(r=!1)}x(l.x,l.y,t)}function m(t){var n=h(0,t.length-1);return t[n]}function s(){var t,n=[];for(t=0;t<pe.rooms.length;t++)n=g(n,pe.rooms[t]);return n}function g(t,n){for(var e,r=n.x;r<n.x+n.mw;)p(r,n.y-1,1,1)&&t.push({x:r,y:n.y-1}),p(r,n.y+n.mh,1,1)&&t.push({x:r,y:n.y+n.mh}),r++;for(e=n.x;e<n.y+n.mh;)p(e,n.x-1,1,1)&&t.push({x:e,y:n.x-1}),p(e,n.x+n.mw,1,1)&&t.push({x:e,y:n.x+n.mw}),e++;return t}function p(t,n,e,r){return w(t,n,e,r)&&!v(t,n,e,r)}function w(t,n,e,r){return t>0&&n>0&&t+e<pe.width&&n+r<pe.height}function v(t,n,e,r){for(var o=null,a=0;a<pe.rooms.length;){o=pe.rooms[a];{if(!(o.x>t+e-1||o.x+o.mw-1<t||o.y>n+r-1||o.y+o.mh-1<n))return!0;a++}}return!1}function b(t){for(var n,e=0,r=null,o=!1,a=100;pe.rooms.length>1&&!o;){for(e=0,e+=k(t),e+=j(t),e+=S(t),e+=F(t),1===t.r.rooms.length&&e>0&&(o=!0),n=0;n<t.d.length;n++)r=t.d[n],A(r,t).r===t.r&&(o=!0);a--,0===a&&(o=!0)}}function k(t){for(var n,e,r,o,a=null,l=null,i=null,h=[],f=t.x;f<t.x+t.mw;)l=M(f,t.y-1),null!==l&&h.push({x:f,y:t.y,o:l}),f++;for(n=0,e=0;e<h.length;e++){for(a=h[e],r=!1,o=0;o<t.d.length;o++)t.d[o].r2===a.o&&(r=!0);Math.random()>ve||y(t.d,a)>=0||r||(i=N(a.x,a.y,"N",t,a.o),t.d.push(i),a.o.d.push(N(a.x,a.y-1,"S",a.o,t)),n++)}return n}function j(t){for(var n,e,r,o,a=null,l=null,i=null,h=[],f=t.x;f<t.x+t.mw;)l=M(f,t.y+t.mh),null!==l&&h.push({x:f,y:t.y+t.mh-1,o:l}),f++;for(n=0,e=0;e<h.length;e++){for(a=h[e],r=!1,o=0;o<t.d.length;o++)t.d[o].r2===a.o&&(r=!0);Math.random()>ve||y(t.d,a)>=0||r||(i=N(a.x,a.y,"S",t,a.o),t.d.push(i),a.o.d.push(N(a.x,a.y+1,"N",a.o,t)),n++)}return n}function S(t){for(var n,e,r,o,a=null,l=null,i=null,h=[],f=t.y;f<t.y+t.mh;)l=M(t.x-1,f),null!==l&&h.push({x:t.x,y:f,o:l}),f++;for(n=0,e=0;e<h.length;e++){for(a=h[e],r=!1,o=0;o<t.d.length;o++)t.d[o].r2===a.o&&(r=!0);Math.random()>ve||y(t.d,a)>=0||r||(i=N(a.x,a.y,"W",t,a.o),t.d.push(i),a.o.d.push(N(a.x-1,a.y,"E",a.o,t)),n++)}return n}function F(t){for(var n,e,r,o,a=null,l=null,i=null,h=[],f=t.y;f<t.y+t.mh;)l=M(t.x+t.mw,f),null!==l&&h.push({x:t.x+t.mw-1,y:f,o:l}),f++;for(n=0,e=0;e<h.length;e++){for(a=h[e],r=!1,o=0;o<t.d.length;o++)t.d[o].r2===a.o&&(r=!0);Math.random()>ve||y(t.d,a)>=0||r||(i=N(a.x,a.y,"E",t,a.o),t.d.push(i),a.o.d.push(N(a.x+1,a.y,"W",a.o,t)),n++)}return n}function M(t,n){for(var e=null,r=0;r<pe.rooms.length;){e=pe.rooms[r];{if(!(e.x>t||e.x+e.mw-1<t||e.y>n||e.y+e.mh-1<n))return e;r++}}return null}function C(t,n,e,r){var o,a=null;for(o=0;o<t.d.length;o++)if(a=t.d[o],a.dir===r&&a.x===t.x+n&&a.y===t.y+e)return a;return null}function E(t){for(var n=0,e=pe.rooms.length;n++<10*t&&pe.rooms.length<e+t;)W()}function W(){var t=m(pe.f);try{P(I(t.x,t.y))}catch(n){console.log(pe,t,n)}}function P(t){if(null===t||!p(t.x,t.y,t.mw,t.mh))return!1;var n=[];n=R(n,t),pe.f=g(n,t),0===pe.f.length&&console.log(n,t,g(n,t)),t.c=pe.cr.color,pe.rooms.push(t),pe.cr.rooms.push(t),b(t)}function g(t,n){for(var e,r=n.x;r<n.x+n.mw;)p(r,n.y-1,1,1)&&t.push({x:r,y:n.y-1}),p(r,n.y+n.mh,1,1)&&t.push({x:r,y:n.y+n.mh}),r++;for(e=n.y;e<n.y+n.mh;)p(n.x-1,e,1,1)&&t.push({x:n.x-1,y:e}),p(n.x+n.mw,e,1,1)&&t.push({x:n.x+n.mw,y:e}),e++;return t}function R(t,n){for(var e=0;e<pe.f.length;e++)pe.f[e].x>=n.x-1&&pe.f[e].x<=n.x+n.mw&&pe.f[e].y>=n.y&&pe.f[e].y<=n.y+n.mh-1||pe.f[e].x>=n.x&&pe.f[e].x<=n.x+n.mw-1&&pe.f[e].y>=n.y-1&&pe.f[e].y<=n.y+n.mh||t.push(pe.f[e]);return t}function I(t,n){for(var e=0,r=1,o=1;e++<25&&(r<pe.cr.maxW||o<pe.cr.maxH)&&Math.random()<.9;)switch(parseInt(4*Math.random())){case 0:o<pe.cr.maxH&&p(t,n-1,r,o+1)&&(n--,o++);continue;case 1:o<pe.cr.maxH&&p(t,n,r,o+1)&&o++;continue;case 2:r<pe.cr.maxW&&p(t-1,n,r+1,o)&&(t--,r++);continue;case 3:r<pe.cr.maxW&&p(t,n,r+1,o)&&r++;continue;default:continue}return B(t,n,r,o,pe.cr)}function B(t,n,e,r,o){return{x:t,y:n,mw:e,mh:r,c:null,r:o,s:0,sx:0,sy:0,sr:!1,v:!1,d:[],map:null}}function N(t,n,e,r,o){return{x:t,y:n,dt:0,dir:e,r1:r,r2:o}}function O(){var t,n,e=null,r=null;for(t=0;t<pe.rooms.length;t++)for(e=pe.rooms[t],e.s=0,n=0;n<e.d.length;n++)r=e.d[n],r.dt=0}function L(){var t,n,e,r=null,o=null,a=null,l=null;for(t=0;t<pe.r.length;t++)for(o=pe.r[t],l=m(o.rooms),l.s=(t+1)%ke.length,n=0;n<o.rooms.length;n++)for(l=o.rooms[n],e=0;e<l.d.length;e++)r=l.d[e],a=A(r,l).r,a!==o&&0===r.dt&&(r.dt=(t+1)%ke.length)}function D(t){-1===ce.keys.indexOf(t.s)&&(ce.keys.push(t.s),H())}function H(){var t,n,e,r,o,a,l;for(t=0;t<pe.rooms.length;t++){for(n=!1,e=pe.rooms[t],ce.keys.indexOf(e.s)>-1&&(e.s=0),r=0;r<e.d.length;r++)o=e.d[r],ce.keys.indexOf(o.dt)>-1&&(o.dt=0,n=!0);if(n&&null!==e.map)for(0===e.s&&(a=e.map.map.indexOf(9),a>-1&&(e.map.map[a]=0)),l=0;l<e.map.map.length;l++)e.map.map[l]>1&&ce.keys.indexOf(e.map.map[l]-1)>-1&&(e.map.map[l]=0)}}function A(t,n){return t.r1===n?t.r2:t.r1}function T(){pe={width:0,height:0,rooms:[],f:[],r:[],cr:0},be=0,pe.width=80,pe.height=48,x(40,24,z()),E(1)}function z(){var t=q(ke[be],parseInt(3*Math.random())+parseInt(3*Math.random())+1,parseInt(3*Math.random())+parseInt(3*Math.random())+1);return be=(be+1)%ke.length,t}function q(t,n,e){return{color:t,maxW:n,maxH:e,rooms:[]}}function U(){T()}function G(){W()}function J(){c(z())}function K(){O(),L()}function Q(t,n){n=n.split("");for(var e=0;e<n.length;e++)n[e]=parseInt(n[e]);return{map:n,type:t}}function V(t){return{map:t.map.slice(0),type:t.type}}function X(t,n,e,r){var o,a,l,i,h,f,y,u,x,c,m,s,g,p,w,v=[],b=[],k=Math.max(t,n);for(o=0;k*k>o;o++)v[o]=0;for(v=r(v,t,n,k),l={},u=0;10*k>u;u++)for(x=0;10*k>x;x++)c=Math.floor(x/10),m=Math.floor(u/10),i=C(e,c,m,"N"),h=C(e,c,m,"E"),f=C(e,c,m,"S"),y=C(e,c,m,"W"),s=d(c,m,k),g=c+"-"+m,(x%10===0||u%10===0)&&(l[g]||(a=V(Me[v[s]]),l[g]=a),a=l[g]),p=d(x,u,10*k),w=d(x%10,u%10,10),b[p]=a.map[w],0===u&&null===i&&10*t>x&&(b[p]=1),0===x&&null===y&&10*n>u&&(b[p]=1),u===10*n-1&&null===f&&10*t>x&&(b[p]=1),x===10*t-1&&null===h&&10*n>u&&(b[p]=1),0===u&&null!==i&&10*t>x&&i.dt>0&&0===b[p]&&(b[p]=i.dt+1),0===x&&null!==y&&10*n>u&&y.dt>0&&0===b[p]&&(b[p]=y.dt+1),u===10*n-1&&null!==f&&10*t>x&&f.dt>0&&0===b[p]&&(b[p]=f.dt+1),x===10*t-1&&null!==h&&10*n>u&&h.dt>0&&0===b[p]&&(b[p]=h.dt+1);return{map:b,width:t,height:n,size:k,tiles:10*k}}function Y(t){var n,e,r,o;if(t.map=X(1*t.mw,1*t.mh,t,function(n,e,r,o){var a,l,i,f,y,u,x,c=0,m=0,s=0;for(a=0;o*o>a;a++)l=C(t,c,m,"N"),i=C(t,c,m,"E"),f=C(t,c,m,"S"),y=C(t,c,m,"W"),u=[1,3,4,9],x=[2,9,10,11],(0===c||0===m||c===e-1||m===r-1)&&(s=9),(0===c||c===e-1)&&(s=x[h(0,3)]),(0===m||m===r-1)&&(s=u[h(0,3)]),1===t.mw&&(s=x[h(0,3)]),1===t.mh&&(s=u[h(0,3)]),(l||f||i||y)&&(s=9),n[d(c,m,o)]=s,c++,c>e-1&&(c=0,m++),m>r-1&&(a=o*o);return n}),t.s>0){for(n=h(1,1*t.mw)-1,e=h(1,1*t.mh)-1,r=h(1,9),o=h(1,9);0!==t.map.map[d(r,o,t.map.tiles)];)r=h(1,9),o=h(1,9);t.map.map[d(10*n+r,10*e+o,t.map.tiles)]=9}}function Z(){var t=ne.canvas,n=t.width/2,e=t.height/2;ce.x-Cn+n>t.width?Cn=ce.x-(t.width-n):ce.x-n<Cn&&(Cn=ce.x-n),ce.y-En+e>t.height?En=ce.y-(t.height-e):ce.y-e<En&&(En=ce.y-e),En=~~(.5+En),En=~~(.5+En)}function $(){var t=re.canvas,n=t.width/2,e=t.height/2,r=16*(we.x+f(f(f(ce.x),10),1)),o=16*(we.y+f(f(f(ce.y),10),1));r-Wn+n>t.width?Wn=r-(t.width-n):Wn>r-n&&(Wn=r-n),o-Pn+e>t.height?Pn=o-(t.height-e):Pn>o-e&&(Pn=o-e),Pn=~~(.5+Pn),Pn=~~(.5+Pn)}function _(){var t,n,e,r,o,a,l,i,h,y;for(ee.strokeStyle=we.c.bd,ee.lineWidth=2,Z(),ne.fillStyle=we.c.bd,ne.fillRect(0,0,$n.width,$n.height),ne.fillStyle=we.c.bg,ne.clearRect(0-Cn,0-En,Fe,Se),t=f(Cn)-1,n=f(En)-1,e=f(Cn)+f(Zn.width)+2,r=f(En)+f(Zn.height)+2,0>t&&(t=0),0>n&&(n=0),e>je&&(e=je),r>je&&(r=je),o=n;r>o;o++)for(a=0,l=16*-je*2,i=0,ne.fillStyle=we.c.bg,y=t;e>y;y++)0!==Tn[d(y,o,je)]&&(a+=16,l===16*-je*2&&(l=16*y-Cn),h=0>o-1?-1:Tn[d(y,o-1,je)],0===h&&(i=1)),(0===Tn[d(y,o,je)]||y===e-1)&&tn(o,l,a,i),(0===Tn[d(y,o,je)]||y===e-1)&&(a=0,l=16*-je*2,i=0);for(o=n;r>o;o++)for(y=t;e>y;y++)Tn[d(y,o,je)]>1&&(ne.fillStyle=9===Tn[d(y,o,je)]?ke[we.s].l:ke[Tn[d(y,o,je)]-1].bg,tn(o,16*y-Cn,16,!0));nn(t,n,e,r,1),nn(t,n,e,r,4),en(t,n,e,r,2),en(t,n,e,r,8)}function tn(t,n,e,r){var o=n,a=16*t-En;1===r?ne.fillRect(o,a-5,e,21):ne.fillRect(o,a,e,16)}function nn(t,n,e,r,o){var a,l,i,h,f,y,u,x,c,m,s,g,p,w;for(a=t;e>a;a++)for(l=0,i=16*-je*2,h=0,f=0,y=n;r>y;y++)u=Tn[d(a+1,y-1,je)],x=Tn[d(a,y-1,je)],c=Tn[d(a-1,y-1,je)],1===o?(f=Tn[d(a-1,y,je)],0>a-1&&(f=-1)):4===o&&(f=Tn[d(a+1,y,je)],a+1>je-1&&(f=-1)),0!==Tn[d(a,y,je)]&&1>f&&(l+=16,i===16*-je*2&&(0===x&&(h=1),i=16*y-En)),(0===Tn[d(a,y,je)]||y===r-1||f>0)&&(ee.beginPath(),m=i,s=16*a-Cn,g=m+l,p=16*(a+1)-Cn,w=s,4===o&&(w=p),h&&(m-=5),(4===o&&0===u||1===o&&0===c)&&f>0?rn(w,m,w,g+3):rn(w,m,w,g),ee.closePath(),ee.stroke()),(0===Tn[d(a,y,je)]||y===r-1||f>0)&&(l=0,i=16*-je*2,h=0)}function en(t,n,e,r,o){var a,l,i,h,f,y,u,x,c,m;for(a=n;r>a;a++)for(l=0,i=16*-je*2,h=0,f=0,y=t;e>y;y++)2===o?0>a-1?f=-1:(f=Tn[d(y,a-1,je)],h=1):8===o&&(f=Tn[d(y,a+1,je)],a+1>je-1&&(f=-1)),0!==Tn[d(y,a,je)]&&1>f&&(l+=16,i===16*-je*2&&(i=16*y-Cn)),(0===Tn[d(y,a,je)]||y===e-1||f>0)&&(ee.beginPath(),u=i,x=16*a-En,c=u+l,m=16*(a+1)-En,2===o?1===h?(rn(u,x-5,c,x-5),rn(u,x+3,c,x+3)):rn(u,x,c,x):8===o&&rn(u,m,c,m),ee.closePath(),ee.stroke()),(0===Tn[d(y,a,je)]||y===e-1||f>0)&&(l=0,i=16*-je*2,h=0)}function rn(t,n,e,r){ee.moveTo(t,n),ee.lineTo(e,r)}function on(){var t,n,e,r,o;for($(),Nn=16*we.x+16*f(f(f(ce.x),10),1),On=16*we.y+16*f(f(f(ce.y),10),1),oe.width=150,oe.height=150,re.clearRect(0,0,oe.width,oe.height),Ln.length=0,re.lineWidth=2,re.fillStyle="#000",t=0;t<pe.r.length;t++)for(n=0;n<pe.r[t].rooms.length;n++)e=pe.r[t].rooms[n],r=16*e.x-Wn,o=16*e.y-Pn,r+16*e.mw>0&&o+16*e.mh>0&&r<oe.width&&o<oe.height&&(re.beginPath(),re.rect(r,o,16*e.mw,16*e.mh),re.fill(),re.closePath());an("bg","bd",function(t,n,e){t.v&&(re.beginPath(),re.rect(n,e,16*t.mw,16*t.mh),re.fill(),re.stroke(),re.closePath())},re),Bn.clearRect(0,0,16,16),an("bg","bd",function(t,n,e){t.v&&(Bn.beginPath(),Bn.rect(n/16*2,e/16*2,2*t.mw,2*t.mh),Bn.fill(),Bn.stroke(),Bn.closePath())},Bn),Rn.href=In.toDataURL(),an(0,"bg",fn,re),an(0,0,ln,re),yn()}function an(t,n,e,r){var o,a,l,i,h,f=r||re;for(o=0;o<pe.r.length;o++)for("string"==typeof t&&(f.fillStyle=pe.r[o].color[t]),"string"==typeof n&&(f.strokeStyle=pe.r[o].color[n]),a=0;a<pe.r[o].rooms.length;a++)l=pe.r[o].rooms[a],i=16*l.x-Wn,h=16*l.y-Pn,i+16*l.mw>0&&h+16*l.mh>0&&i<oe.width&&h<oe.height&&e(l,i,h,f)}function ln(t){var n,e,r;if(t.v){for(n=null,e=null,r=0;r<t.d.length;r++)if(n=t.d[r],n.dt>0)switch(e=ke[n.dt].l,n.dir){case"N":hn(16*n.x+5,16*n.y,e);continue;case"S":hn(16*n.x+5,16*n.y+16,e);continue;case"W":hn(16*n.x-3,16*n.y+8,e);continue;case"E":hn(16*n.x+13,16*n.y+8,e);continue;default:continue}t.s>0&&(e=ke[t.s].l,hn(16*(t.x+t.mw/2)-3,16*(t.y+t.mh/2),"rgba(0,0,0,0)",e))}}function hn(t,n,e,r){var o=3;re.beginPath(),re.arc(t+o-Wn,n-Pn,o,0,2*Math.PI,!1),re.fillStyle=e,re.fill(),r&&(re.lineWidth=2,re.strokeStyle=r,re.stroke()),re.closePath()}function fn(t){var n,e,r,o,a,l;if(t.v)for(n=null,e=0;e<t.d.length;e++)n=t.d[e],r=t.x+"-"+t.y+"-"+n.r2.x+"-"+n.r2.y,o=n.r2.x+"-"+n.r2.y+"-"+t.x+"-"+t.y,-1===Ln.indexOf(o)&&-1===Ln.indexOf(r)&&(a=16*n.x,l=16*n.y,"N"===n.dir&&dn(a+4,l,a+16-4,l),"S"===n.dir&&dn(a+4,16*(n.y+1),a+16-4,16*(n.y+1)),"W"===n.dir&&dn(a,l+4,a,l+16-4),"E"===n.dir&&dn(16*(n.x+1),l+4,16*(n.x+1),l+16-4),Ln.push(r))}function dn(t,n,e,r){re.beginPath(),re.moveTo(t-Wn,n-Pn),re.lineTo(e-Wn,r-Pn),re.stroke(),re.closePath()}function yn(){var t,n,e,r;for(Hn||(le.width=oe.width,le.height=oe.height,ae.lineWidth=1,Hn=!0),te.fillStyle="#000000",t=0;t<se.length;t++)n=se[t],e=(15-15*(ce.ῼ/ce.mῼ)).toString(16),te.fillStyle="#"+e+e+"0000",te.fillRect(n.x-Cn,n.y-En,n.w,n.h);ae.clearRect(0,0,le.width,le.height),Dn+=2*(me/1e3),Dn%=2,r=1,Dn>1&&(r=0),An!==r&&(ae.fillStyle="rgba(200,200,255,"+.6*r+")",ae.strokeStyle="rgba(200,200,255,"+.8*r+")"),ae.beginPath(),ae.rect(Nn-Wn,On-Pn,16,16),ae.fill(),ae.stroke(),ae.closePath(),Bn.beginPath(),Bn.fillStyle="rgba(200,200,255,1)",Bn.strokeStyle="rgba(200,200,255,1)",Bn.rect((Nn-Wn)/16*2,(On-Pn)/16*2,2,2),Bn.fill(),Bn.stroke(),Bn.closePath(),An=r}function un(t){for(var n in ge)ge[n]===t.keyCode&&t.preventDefault();xe[t.keyCode]!==t.type&&t.keyCode===ge.space&&(ce.j=1),xe[t.keyCode]=t.type,t.keyCode===ge.d?ce.xd=1:t.keyCode===ge.a&&(ce.xd=-1)}function xn(t){for(var n in ge)ge[n]===t.keyCode&&t.preventDefault();xe[t.keyCode]!==t.type&&t.keyCode===ge.space&&(ce.j=0),xe[t.keyCode]=t.type,(t.keyCode===ge.d||t.keyCode===ge.a)&&(xe[ge.d]&&xe[ge.a]?xe[ge.d]===t.type&&xe[ge.a]===t.type&&(ce.xd=0):ce.xd=0)}function cn(t,n,e){var r,o,a,l,i;for(r=0;r<t.d.length;r++)o=!1,a=t.d[r],a.dir===n&&(("N"===a.dir||"S"===a.dir)&&(o=e===a.x),("E"===a.dir||"W"===a.dir)&&(o=e===a.y),o&&(l=1*(a.x-t.x),i=1*(a.y-t.y),-1===ce.y&&(ce.y=10*i*16+80),-1===ce.x&&(ce.x=10*l*16+80),"N"===a.dir&&(l+=Math.floor(.5),ce.y=0,0!==a.dt&&(ce.y=16),ce.x=ce.x%160+10*l*16),"E"===a.dir&&(i+=Math.floor(.5),l+=1,ce.x=10*t.mw*16*1-ce.w,0!==a.dt&&(ce.x-=16),ce.y=ce.y%160+10*i*16),"S"===a.dir&&(l+=Math.floor(.5),i+=1,ce.y=10*t.mh*16*1-ce.h,0!==a.dt&&(ce.y-=16),ce.x=ce.x%160+10*l*16),"W"===a.dir&&(i+=Math.floor(.5),ce.x=0,0!==a.dt&&(ce.x=16),ce.y=ce.y%160+10*i*16)))}function mn(){var n,e,r,o,a,l,i,h,d,y;for(n=0;n<we.d.length;n++)e=we.d[n],r=1*(e.x-we.x),o=1*(e.y-we.y),a=f(f(ce.x),10),l=f(f(ce.x+ce.w),10),i=f(f(ce.y),10),h=f(f(ce.y+ce.h),10),d=10*we.mw*16*1,y=10*we.mh*16*1,"N"===e.dir&&(r+=Math.floor(.5)),"E"===e.dir&&(o+=Math.floor(.5),r+=1),"S"===e.dir&&(r+=Math.floor(.5),o+=1),"W"===e.dir&&(o+=Math.floor(.5)),t.performance.now()-ce.dc>400&&(ce.x<=0&&-1===ce.xd&&"W"===e.dir&&r===a&&o===i&&gn(e.r2,"E",e.y),ce.y<=0&&-1===ce.yd&&"N"===e.dir&&r===a&&o===i&&gn(e.r2,"S",e.x),ce.x+ce.w>=d&&1===ce.xd&&"E"===e.dir&&r===l&&o===i&&gn(e.r2,"W",e.y),ce.y+ce.h>=y&&0!==ce.yd&&Math.abs(ce.ya)>5&&"S"===e.dir&&r===a&&(o===h||o===i)&&gn(e.r2,"N",e.x))}function sn(){var e,r,o,a,l,i;Kn&&(null===we&&(Xn=Yn),e=Zn.width,r=Zn.height,o=e,a=r,Yn>Xn&&(o=e*Xn/Yn,o=e-o,a=r*Xn/Yn,a=r-a),Xn>=Yn&&(we!==Jn&&(ee.clearRect(0,0,e,r),ne.clearRect(0,0,e,r),we=Jn,we.v=!0,je=Jn.map.tiles,Tn=Jn.map.map,qn=10*Jn.map.height,zn=10*Jn.map.width,Se=10*Jn.map.height*16,Fe=10*Jn.map.width*16,cn(Jn,Un,Gn),n.title=we.c.name,history.pushState(null,null,"#"+n.title)),o=e*(Xn-Yn)/Yn,a=r*(Xn-Yn)/Yn),Qn.width=e,Qn.height=r,Vn.clearRect(0,0,e,r),on(),_(),Vn.drawImage($n,0,0),Vn.drawImage(_n,0,0),Vn.drawImage(Zn,0,0),te.clearRect(0,0,e,r),_n.style.display="none",$n.style.display="none",Vn.globalCompositeOperation="destination-in",l=ce.x+ce.w/2-Cn-o/2,i=ce.y+ce.h/2-En-a/2,Vn.beginPath(),Vn.rect(l,i,o,a),Vn.fillStyle="black",Vn.fill(),te.drawImage(Qn,0,0),Xn+=2*Yn*(me/1e3),Xn>2*Yn&&(Xn=0,ie=!0,Jn=null,Kn=!1,_n.style.display="initial",$n.style.display="initial",ce.dc=t.performance.now()))}function gn(t,n,e){Un=n,Gn=e,Kn=!0,Jn=t,ie=!1,null===t.map&&Y(t)}function pn(t,n){ue[t]||(ue[t]=[]),ue[t].push(n)}function wn(t){var n,e=t.type;if(ue[e]&&ue[e].length>0)for(n=0;n<ue[e].length;n++)ue[e][n](t)}function vn(t){return n.getElementById(t)}function bn(){var t,n,e,r,o,a;for(Zn=vn("p"),_n=vn("b"),$n=vn("t"),oe=vn("m"),le=vn("i"),te=Zn.getContext("2d"),ee=_n.getContext("2d"),ne=$n.getContext("2d"),re=oe.getContext("2d"),ae=le.getContext("2d"),kn(),U(),t=0;t<ke.length;t++){for(n=h(1,2),e=0;n>e;e++)G();t+1<ke.length&&J()}K(),r=pe.rooms[0].d[0],o=r.dir,a=r.x,("E"===r.dir||"W"===r.dir)&&(a=r.y),gn(pe.rooms[0],o,a),Sn()}function kn(){_n.width=Zn.width=$n.width=t.innerWidth>300?300:t.innerWidth,_n.height=Zn.height=$n.height=t.innerHeight>300?300:t.innerHeight}function jn(){var t,n;if(ie){for(t=0;t<se.length;t++)n=se[t],e(n),n.x=u(n.x),n.y=u(n.y),l(n),a(n),r(n),mn(),o(n);te.clearRect(0,0,Zn.width,Zn.height),ee.clearRect(0,0,_n.width,_n.height),_(),on()}}function Sn(){de=t.performance.now(),me=de-ye,ye=de,n.dispatchEvent(fe),he&&requestAnimationFrame(Sn)}var Fn,Mn,Cn,En,Wn,Pn,Rn,In,Bn,Nn,On,Ln,Dn,Hn,An,Tn,zn,qn,Un,Gn,Jn,Kn,Qn,Vn,Xn,Yn,Zn,$n,_n,te,ne,ee,re,oe,ae,le,ie,he,fe,de,ye,ue,xe,ce,me,se,ge,pe=null,we=null,ve=.2,be=0,ke=[{bg:"#BBBBBB",bd:"#A0A0A0",o:"#CFCFCF",l:"#FFFFFF",name:"Dungeon"},{bd:"#990000",bg:"#FF3333",o:"#FF0000",l:"#FF0000",name:"Fire"},{bd:"#006600",bg:"#00BB00",o:"#00BB00",l:"#00FF00",name:"Air"},{bd:"#000066",bg:"#3333FF",o:"#0000FF",l:"#0000FF",name:"Water"},{bg:"#9F9F9F",bd:"#555555",o:"#555555",l:"#000000",name:"Earth"}],je=0,Se=0,Fe=0,Me=[],Ce=[];for(Fn=0;100>Fn;Fn++)Ce[Fn]=0;for(Mn="1111111111111111111111111111110000000000000000000000000000001111111111111111111111111111111111111111,1100000011111000001111110000111100000011110000001111000000111100000111110000111111000000111100000011,1000000001110000001111100001110001001000000000000000000000000000000000000111100011111111111111111111,1111111111111000011100000000000000000000000011000000011110000000000000000000000011000000111100000111,1100000011110000001111000001111110000001111000000011110000001111100000111111000011111111111111111111,1111111111100000000110000000001100000000110001100011100011101110000011111100000111110000011111100001,1111111111100000000100000000010000000011000110001100110001110110000111010000111111000011111000011111,1100000011110000001111100000111000000111000000011100000011110000011111000011111111111111111111111111,1110000011110000000100000000000000000000000011000000001100000000000000000000000011000000111100000111,1100000011111000001100110000110000000011000000001100000000110000000111000000111111000000111100000011,1100000011111000001111110000001100000000110000000011000000001100000111110000111111000000111100000011".split(","),Me.push({map:Ce,type:0}),Fn=0;Fn<Mn.length;Fn++)Me.push(Q(Fn+1,Mn[Fn]));Cn=0,En=0,Wn=0,Pn=0,Rn=n.getElementById("f"),In=n.createElement("canvas"),In.height=16,In.width=16,Bn=In.getContext("2d"),Nn=0,On=0,Ln=[],Dn=0,Hn=!1,An=0,Tn=null,zn=0,qn=0,Un=0,Gn=0,Jn=null,Kn=!1,Qn=n.createElement("canvas"),Vn=Qn.getContext("2d"),Xn=0,Yn=1,ie=!0,he=!0,fe=new CustomEvent("frame"),de=t.performance.now(),ye=t.performance.now(),ue={},xe={},ce={x:-1,y:-1,w:16,h:32,img:null,xd:0,yd:1,xa:0,ya:0,maxa:5,jf:7,jh:50,js:0,j:0,ju:0,ht:0,mj:1,a:0,"ῼ":5,dc:t.performance.now(),"mῼ":5,keys:[]},me=de-ye,se=[ce],ge={a:65,w:87,s:83,d:68,space:32,shift:16,ctrl:17,alt:18,tab:9,debug:192},pn("keydown",un),pn("keyup",xn),pn("resize",kn),pn("DOMContentLoaded",bn),pn("frame",jn),pn("frame",sn),t.addEventListener("resize",wn),n.addEventListener("DOMContentLoaded",wn),n.addEventListener("mousedown",wn),n.addEventListener("mouseup",wn),n.addEventListener("keydown",wn),n.addEventListener("keyup",wn),n.addEventListener("frame",wn)}(window,document);