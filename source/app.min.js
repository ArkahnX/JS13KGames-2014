!function(t,e){function n(){var t,e,n,a,i,h,f,y,d,u;for(Ge.strokeStyle=Un.c.bd,Ge.lineWidth=2,$(),Ue.fillStyle=Un.c.bd,Ue.fillRect(0,0,Xe.width,Xe.height),Ue.fillStyle=Un.c.bg,Ue.clearRect(0-An,0-zn,bn,kn),t=j(An)-1,e=j(zn)-1,n=j(An)+j(ze.width)+2,a=j(zn)+j(ze.height)+2,0>t&&(t=0),0>e&&(e=0),n>vn&&(n=vn),a>vn&&(a=vn),i=e;a>i;i++)for(h=0,f=16*-vn*2,y=0,Ue.fillStyle=Un.c.bg,u=t;n>u;u++)0!==Cn[P(u,i,vn)]&&(h+=16,f===16*-vn*2&&(f=16*u-An),d=0>i-1?-1:Cn[P(u,i-1,vn)],0===d&&(y=1)),(0===Cn[P(u,i,vn)]||u===n-1)&&r(i,f,h,y),(0===Cn[P(u,i,vn)]||u===n-1)&&(h=0,f=16*-vn*2,y=0);for(i=e;a>i;i++)for(u=t;n>u;u++)Cn[P(u,i,vn)]>1&&(9===Cn[P(u,i,vn)]&&Un.s>-1?Ue.fillStyle=Kn[Un.s].l:9!==Cn[P(u,i,vn)]&&(Ue.fillStyle=Kn[Cn[P(u,i,vn)]-2].l),r(i,16*u-An,16,!0));o(t,e,n,a,1),o(t,e,n,a,4),l(t,e,n,a,2),l(t,e,n,a,8)}function r(t,e,n,r){var o=e,l=16*t-zn;1===r?Ue.fillRect(o,l-5,n,21):Ue.fillRect(o,l,n,16)}function o(t,e,n,r,o){var l,i,h,f,y,d,u,x,c,m,s,p,g,w;for(l=t;n>l;l++)for(i=0,h=16*-vn*2,f=0,y=0,d=e;r>d;d++)u=Cn[P(l+1,d-1,vn)],x=Cn[P(l,d-1,vn)],c=Cn[P(l-1,d-1,vn)],1===o?(y=Cn[P(l-1,d,vn)],0>l-1&&(y=-1)):4===o&&(y=Cn[P(l+1,d,vn)],l+1>vn-1&&(y=-1)),0!==Cn[P(l,d,vn)]&&1>y&&(i+=16,h===16*-vn*2&&(0===x&&(f=1),h=16*d-zn)),(0===Cn[P(l,d,vn)]||d===r-1||y>0)&&(Ge.beginPath(),m=h,s=16*l-An,p=m+i,g=16*(l+1)-An,w=s,4===o&&(w=g),f&&(m-=5),(4===o&&0===u||1===o&&0===c)&&y>0?a(w,m,w,p+3):a(w,m,w,p),Ge.closePath(),Ge.stroke()),(0===Cn[P(l,d,vn)]||d===r-1||y>0)&&(i=0,h=16*-vn*2,f=0)}function l(t,e,n,r,o){var l,i,h,f,y,d,u,x,c,m;for(l=e;r>l;l++)for(i=0,h=16*-vn*2,f=0,y=0,d=t;n>d;d++)2===o?0>l-1?y=-1:(y=Cn[P(d,l-1,vn)],f=1):8===o&&(y=Cn[P(d,l+1,vn)],l+1>vn-1&&(y=-1)),0!==Cn[P(d,l,vn)]&&1>y&&(i+=16,h===16*-vn*2&&(h=16*d-An)),(0===Cn[P(d,l,vn)]||d===n-1||y>0)&&(Ge.beginPath(),u=h,x=16*l-zn,c=u+i,m=16*(l+1)-zn,2===o?1===f?(a(u,x-5,c,x-5),a(u,x+3,c,x+3)):a(u,x,c,x):8===o&&a(u,m,c,m),Ge.closePath(),Ge.stroke()),(0===Cn[P(d,l,vn)]||d===n-1||y>0)&&(i=0,h=16*-vn*2,f=0)}function a(t,e,n,r){Ge.moveTo(t,e),Ge.lineTo(n,r)}function i(){var t,e,n,r,o;for(_(),Be=16*Un.x+16*j(j(j(on.x),10),1),Ne=16*Un.y+16*j(j(j(on.y),10),1),Ke.width=300,Ke.height=300,Je.clearRect(0,0,Ke.width,Ke.height),De.length=0,Je.lineWidth=2,Je.fillStyle="#000",t=0;t<qn.r.length;t++)for(e=0;e<qn.r[t].rooms.length;e++)n=qn.r[t].rooms[e],r=16*n.x-Xn,o=16*n.y-Yn,r+16*n.mw>0&&o+16*n.mh>0&&r<Ke.width&&o<Ke.height&&(Je.beginPath(),Je.rect(r,o,16*n.mw,16*n.mh),Je.fill(),Je.closePath());h("bg","bd",function(t,e,n){t.v&&(Je.beginPath(),Je.rect(e,n,16*t.mw,16*t.mh),Je.fill(),Je.stroke(),Je.closePath())},Je),Oe.clearRect(0,0,16,16),h("bg","bd",function(t,e,n){t.v&&(Oe.beginPath(),Oe.rect(e/16*2,n/16*2,2*t.mw,2*t.mh),Oe.fill(),Oe.stroke(),Oe.closePath())},Oe),Qn.href=Vn.toDataURL(),h(0,"bg",d,Je),h(0,0,f,Je),c()}function h(t,e,n,r){var o,l,a,i,h,f=r||Je;for(o=0;o<qn.r.length;o++)for("string"==typeof t&&(f.fillStyle=qn.r[o].color[t]),"string"==typeof e&&(f.strokeStyle=qn.r[o].color[e]),l=0;l<qn.r[o].rooms.length;l++)a=qn.r[o].rooms[l],i=16*a.x-Xn,h=16*a.y-Yn,i+16*a.mw>0&&h+16*a.mh>0&&i<Ke.width&&h<Ke.height&&n(a,i,h,f)}function f(t){var e,n,r,o,l;if(t.v){for(e=null,n=null,r=0;r<t.d.length;r++)e=t.d[r],e.dt>-1&&(n=Kn[e.dt].l,o=0,l=0,"N"===e.dir&&(o=5),"S"===e.dir&&(o=5,l=16),"W"===e.dir&&(o=-3,l=8),"E"===e.dir&&(o=13,l=8),y(16*e.x+o,16*e.y+l,n));t.s>-1&&(n=Kn[t.s].l,y(16*(t.x+t.mw/2)-3,16*(t.y+t.mh/2),"rgba(0,0,0,0)",n))}}function y(t,e,n,r){var o=3;Je.beginPath(),Je.arc(t+o-Xn,e-Yn,o,0,2*Math.PI,!1),Je.fillStyle=n,Je.fill(),r&&(Je.lineWidth=2,Je.strokeStyle=r,Je.stroke()),Je.closePath()}function d(t){var e,n,r,o,l,a;if(t.v)for(e=null,n=0;n<t.d.length;n++)e=t.d[n],r=t.x+"-"+t.y+"-"+e.r2.x+"-"+e.r2.y,o=e.r2.x+"-"+e.r2.y+"-"+t.x+"-"+t.y,-1===De.indexOf(o)&&-1===De.indexOf(r)&&(l=16*e.x,a=16*e.y,"N"===e.dir&&u(l+4,a,l+16-4,a),"S"===e.dir&&u(l+4,16*(e.y+1),l+16-4,16*(e.y+1)),"W"===e.dir&&u(l,a+4,l,a+16-4),"E"===e.dir&&u(16*(e.x+1),a+4,16*(e.x+1),a+16-4),De.push(r))}function u(t,e,n,r){Je.beginPath(),Je.moveTo(t-Xn,e-Yn),Je.lineTo(n-Xn,r-Yn),Je.stroke(),Je.closePath()}function x(){for(var t=0;t<on.keys.length;t++)qe.beginPath(),qe.fillStyle=Kn[on.keys[t]].l,qe.rect(on.x-An,on.y-zn+(4-t)*on.h/5,on.w,on.h/5),qe.fill(),qe.closePath()}function c(){var t,e,n,r;for(He||(Ve.width=Ke.width,Ve.height=Ke.height,Qe.lineWidth=1,He=!0),qe.fillStyle="#000000",t=0;t<an.length;t++)e=an[t],n=(15-15*(on.ῼ/on.mῼ)).toString(16),qe.beginPath(),qe.fillStyle="rgba(0,0,0,0.1)",qe.rect(e.x-An,e.y-zn,e.w,e.h),qe.fill(),qe.closePath(),x(),qe.beginPath(),qe.lineWidth=1,qe.strokeStyle="#"+n+n+"0000",qe.fillStyle="rgba(0,0,0,0)",qe.rect(e.x-An,e.y-zn,e.w,e.h),qe.stroke(),qe.closePath();Qe.clearRect(0,0,Ve.width,Ve.height),Te+=2*(ln/1e3),Te%=2,r=1,Te>1&&(r=0),Ae!==r&&(Qe.fillStyle="rgba(200,200,255,"+.6*r+")",Qe.strokeStyle="rgba(200,200,255,"+.8*r+")"),Qe.beginPath(),Qe.rect(Be-Xn,Ne-Yn,16,16),Qe.fill(),Qe.stroke(),Qe.closePath(),Oe.beginPath(),Oe.fillStyle="rgba(200,200,255,1)",Oe.strokeStyle="rgba(200,200,255,1)",Oe.rect((Be-Xn)/16*2,(Ne-Yn)/16*2,2,2),Oe.fill(),Oe.stroke(),Oe.closePath(),Ae=r}function m(){qe.fillStyle=0===on.keys.length?"#000000":Kn[on.keys[wn]].l,qe.strokeStyle="#000000",qe.save(),qe.translate(on.x-An+on.w/2,on.y-zn+on.h/2),qe.rotate(dn),qe.beginPath(),qe.moveTo(10+on.w,0),qe.lineTo(0+on.w,-10),qe.lineTo(0+on.w,10),qe.lineTo(10+on.w,0),qe.fill(),qe.stroke(),qe.closePath(),qe.restore()}function s(){var t,e;for(t=0;t<un.length;t++)e=un[t],qe.fillStyle=Kn[e.key].l,qe.save(),qe.translate(e.x-An,e.y-zn),qe.rotate(e.a),qe.beginPath(),qe.rect(0,0,10,2),qe.fill(),qe.closePath(),qe.restore()}function p(t,e){nn[t]||(nn[t]=[]),nn[t].push(e)}function g(t){var e,n=t.type;if(nn[n]&&nn[n].length>0)for(e=0;e<nn[n].length;e++)nn[n][e](t)}function w(t){return e.getElementById(t)}function v(){var t,n,r,o,l,a,i;for(ze=w("p"),Ye=w("b"),Xe=w("t"),Ke=w("m"),Ve=w("i"),qe=ze.getContext("2d"),Ge=Ye.getContext("2d"),Ue=Xe.getContext("2d"),Je=Ke.getContext("2d"),Qe=Ve.getContext("2d"),k(),We(),t=0;t<Kn.length;t++){for(n=M(1,2),r=0;n>r;r++)Ie();t+1<Kn.length&&Le()}Re(),o=qn.rooms[0].d[0],l=o.dir,a=o.x,("E"===o.dir||"W"===o.dir)&&(a=o.y),Z(qn.rooms[0],l,a),S(),i=e.createElement("span"),i.innerHTML="<p>A, D, to move</p><p>space to jump</p><p>mouse to aim</p><p>left click to take colors</p><p>right click to place colors</p><p>middle click to change colors</p>",e.body.appendChild(i)}function k(){Ye.width=ze.width=Xe.width=t.innerWidth>300?300:t.innerWidth,Ye.height=ze.height=Xe.height=t.innerHeight>300?300:t.innerHeight}function b(){var t,e;if(Ze){for(t=0;t<an.length;t++)e=an[t],D(e),e.x=F(e.x),e.y=F(e.y),z(e),A(e),T(e),Q(),H(e);for(O(),t=0;t<un.length;t++)Y(un[t]);qe.clearRect(0,0,ze.width,ze.height),Ge.clearRect(0,0,Ye.width,Ye.height),n(),i(),m(),s()}}function S(){tn=t.performance.now(),ln=tn-en,en=tn,e.dispatchEvent(_e),$e&&requestAnimationFrame(S)}function M(t,e){return Math.floor(Math.random()*(e-t+1)+t)}function j(t,e){var n=t%(e||16);return(t-n)/(e||16)}function P(t,e,n){return e*n+t}function E(t,e){var n,r,o;if("object"==typeof e){for(n=0;n<t.length;n++)if(r=!0,"object"==typeof t[n]){for(o in e)if(t[n][o]!==e[o]){r=!1;break}if(r===!0)return n}return-1}return t.indexOf(e)}function F(t){return~~(.5+t)}function C(t){for(var e in hn)hn[e]===t.keyCode&&t.preventDefault();rn[t.keyCode]!==t.type&&t.keyCode===hn.space&&(on.j=1),rn[t.keyCode]=t.type,t.keyCode===hn.d?on.xd=1:t.keyCode===hn.a&&(on.xd=-1)}function W(t){for(var e in hn)hn[e]===t.keyCode&&t.preventDefault();rn[t.keyCode]!==t.type&&t.keyCode===hn.space&&(on.j=0),rn[t.keyCode]=t.type,(t.keyCode===hn.d||t.keyCode===hn.a)&&(rn[hn.d]&&rn[hn.a]?rn[hn.d]===t.type&&rn[hn.a]===t.type&&(on.xd=0):on.xd=0)}function I(t){t.target===ze&&(pn=t.layerX,gn=t.layerY),fn=t.clientX,yn=t.clientY,dn=Math.atan2(ze.offsetTop+on.y-zn-yn,ze.offsetLeft+on.x-An-fn)+Math.PI}function L(t){t.preventDefault(),1===t.which&&(cn=!0),2===t.which&&(wn++,wn>on.keys.length-1&&(wn=0))}function R(t){t.preventDefault(),1===t.which&&(cn=!1)}function O(){cn&&t.performance.now()-xn>mn&&on.keys.length>0&&(xn=t.performance.now(),un.push(N(on.x+on.w/2+10*Math.cos(dn),on.y+on.h/2+10*Math.sin(dn),dn,on.keys[wn])))}function B(t){var e,n,r;t.preventDefault(),e=pn+An,n=gn+zn,e>=0&&16*Wn>e&&n>=0&&16*In>n&&(r=P(j(e),j(n),vn),0===Cn[r]&&sn[on.keys[wn]]>0&&(Cn[r]=1,sn[on.keys[wn]]--))}function N(t,e,n,r){return{x:t,y:e,a:n,key:r}}function D(t){t.xa=t.xa+t.xd/60*ln,t.xa>t.maxa&&(t.xa=t.maxa),t.xa<-t.maxa&&(t.xa=-t.maxa),0===t.xd&&(t.xa>0?t.xa=t.xa+-2/60*ln:t.xa<0&&(t.xa=t.xa+2/60*ln),(t.xa<1/60*ln&&t.xa>-1/60*ln||1===t.yd||-1===t.yd)&&(t.xa=0)),t.x=t.x+t.xa}function T(t){t.j&&-1!==t.yd&&t.ju<t.mj&&(t.mj>1&&0===t.ju&&1===t.yd&&t.ju++,(0===t.ju&&0===t.yd||t.ju>0||t.mj>1)&&(t.yd=-1,t.ya=-t.jf,t.js=t.y,t.ju++),t.ht=0),(0===t.yd||!t.j||t.ht>t.jh)&&(t.yd=1),1===t.yd&&(t.j=0,t.ya=t.ya+t.jf/2/60*ln),0===t.yd&&(t.ya>0?t.ya=t.ya+-1/60*ln:t.ya<0&&(t.ya=t.ya+1/60*ln),t.ya<1/60*ln&&t.ya>-1/60*ln&&(t.ya=0)),t.ya>t.maxa&&(t.ya=10),t.ht-=t.ya,t.ht=F(t.ht),t.y=t.y+t.ya}function H(t){var e=t.x%16,n=P(j(t.x),j(t.y+t.h),vn),r=P(j(t.x+t.w),j(t.y+t.h),vn),o=!1;o=0===e?X(Cn[n]):X(Cn[r])||X(Cn[n]),(o||t.y+t.h>16*In)&&1===t.yd&&(t.y=16*j(t.y),t.ya=0,t.yd=0,t.ju=0,t.j=0,t.ht=0)}function A(t){var e=t.x%16,n=P(j(t.x),j(t.y-t.h/2),vn),r=P(j(t.x+t.w),j(t.y-t.h/2),vn),o=!1;o=0===e?X(Cn[n]):X(Cn[n])||X(Cn[r]),o&&1===t.j&&(t.y=16*j(t.y),t.ya=-1,t.yd=1,t.j=0,t.ht=0)}function z(t){var e=t.y%16,n=t.x%16,r=P(j(t.x),j(t.y-t.h/2),vn),o=P(j(t.x+t.w),j(t.y-t.h/2),vn),l=P(j(t.x),j(t.y),vn),a=P(j(t.x+t.w),j(t.y),vn),i=P(j(t.x),j(t.y+t.h/2),vn),h=P(j(t.x+t.w),j(t.y+t.h/2),vn),f=P(j(t.x),j(t.y+t.h),vn),y=P(j(t.x+t.w),j(t.y+t.h),vn),d=!1,u=!1;0===e?(d=X(Cn[i])||X(Cn[l]),u=X(Cn[h])||X(Cn[a])):16*j(t.y+t.h)>t.y+t.h?(d=X(Cn[i])||X(Cn[l])||X(Cn[r]),u=X(Cn[h])||X(Cn[a])||X(Cn[o])):(d=X(Cn[i])||X(Cn[l])||X(Cn[f]),u=X(Cn[h])||X(Cn[a])||X(Cn[y])),0===n?(u||t.x+t.w>16*Wn||t.x<0)&&t.xa>0&&(t.x=16*j(t.x),t.xa=0):(u||t.x+t.w>16*Wn||t.x<0)&&t.xa>0?(t.x=16*j(t.x),t.xa=0):(d||t.x+t.w>16*Wn||t.x<0)&&t.xa<0&&(t.x=16*j(t.x+t.w),t.xa=0)}function X(t){return 9===t&&Me(Un),0!==t}function Y(t){var e,n,r,o,l=!1;t.x+=Math.cos(t.a)*(10/60)*ln,t.y+=Math.sin(t.a)*(10/60)*ln,e=j(t.x),n=j(t.y),r=P(e,n,vn),0!==Cn[r]&&(Cn[r]>1&&on.keys.indexOf(Cn[r]-2)>-1&&(sn[Cn[r]-2]++,Cn[r]=0),l=!0),(t.x>16*Wn||t.x<0||t.y>16*In||t.y<0)&&(l=!0),l&&(o=un.indexOf(t),o>-1&&un.splice(o,1))}function q(t,e){e=e.split("");for(var n=0;n<e.length;n++)e[n]=parseInt(e[n]);return{map:e,type:t}}function U(t){return{map:t.map.slice(0),type:t.type}}function G(t,e,n,r){var o,l,a,i,h,f,y,d,u,x,c,m,s,p,g,w=[],v=[],k=Math.max(t,e);for(o=0;k*k>o;o++)w[o]=0;for(w=r(w,t,e,k),a={},d=0;10*k>d;d++)for(u=0;10*k>u;u++)x=Math.floor(u/10),c=Math.floor(d/10),i=ce(n,x,c,"N"),h=ce(n,x,c,"E"),f=ce(n,x,c,"S"),y=ce(n,x,c,"W"),m=P(x,c,k),s=x+"-"+c,(u%10===0||d%10===0)&&(a[s]||(l=U(jn[w[m]]),a[s]=l),l=a[s]),p=P(u,d,10*k),g=P(u%10,d%10,10),v[p]=l.map[g],0===v[p]&&9!==l.type&&10*t>u&&10*e>d&&10*t>u&&10*e>d&&(v[p]=n.r.id+2),0===d&&null===i&&10*t>u&&(v[p]=1),0===u&&null===y&&10*e>d&&(v[p]=1),d===10*e-1&&null===f&&10*t>u&&(v[p]=1),u===10*t-1&&null===h&&10*e>d&&(v[p]=1),0===d&&null!==i&&10*t>u&&i.dt>-1&&0===v[p]&&(v[p]=i.dt+2),0===u&&null!==y&&10*e>d&&y.dt>-1&&0===v[p]&&(v[p]=y.dt+2),d===10*e-1&&null!==f&&10*t>u&&f.dt>-1&&0===v[p]&&(v[p]=f.dt+2),u===10*t-1&&null!==h&&10*e>d&&h.dt>-1&&0===v[p]&&(v[p]=h.dt+2);return{map:v,width:t,height:e,size:k,tiles:10*k}}function J(t){var e,n,r,o;if(t.map=G(1*t.mw,1*t.mh,t,function(e,n,r,o){var l,a,i,h,f,y,d,u=0,x=0,c=0;for(l=0;o*o>l;l++)a=ce(t,u,x,"N"),i=ce(t,u,x,"E"),h=ce(t,u,x,"S"),f=ce(t,u,x,"W"),y=[1,3,4,9],d=[2,9,10,11],(0===u||0===x||u===n-1||x===r-1)&&(c=M(0,11)),(0===u||u===n-1)&&(c=d[M(0,3)]),(0===x||x===r-1)&&(c=y[M(0,3)]),(0===u&&0===x||u===n-1&&0===x||u===n-1&&x===r-1||0===u&&x===r-1)&&(c=9),1===t.mw&&(c=d[M(0,3)]),1===t.mh&&(c=y[M(0,3)]),0===u&&0===x&&(c=6),u===n-1&&0===x&&(c=7),0===u&&x===r-1&&(c=5),u===n-1&&x===r-1&&(c=8),(a||h||i||f)&&(c=9),e[P(u,x,o)]=c,u++,u>n-1&&(u=0,x++),x>r-1&&(l=o*o);return e}),t.s>-1){for(e=M(1,1*t.mw)-1,n=M(1,1*t.mh)-1,r=M(1,9),o=M(1,9);0!==t.map.map[P(10*e+r,10*n+o,t.map.tiles)]&&t.map.map[P(10*e+r,10*n+o,t.map.tiles)]!==t.r.id+2;)console.log(t.map.map[P(10*e+r,10*n+o,t.map.tiles)],t.r.id+2),r=M(1,9),o=M(1,9),e=M(1,1*t.mw)-1,n=M(1,1*t.mh)-1;t.map.map[P(10*e+r,10*n+o,t.map.tiles)]=9}}function K(t,e,n){var r,o,l,a,i;for(r=0;r<t.d.length;r++)o=!1,l=t.d[r],l.dir===e&&(("N"===l.dir||"S"===l.dir)&&(o=n===l.x),("E"===l.dir||"W"===l.dir)&&(o=n===l.y),o&&(a=1*(l.x-t.x),i=1*(l.y-t.y),-1===on.y&&(on.y=10*i*16+80),-1===on.x&&(on.x=10*a*16+80),"N"===l.dir&&(a+=Math.floor(.5),on.y=0,l.dt>-1&&(on.y=16),on.x=on.x%160+10*a*16),"E"===l.dir&&(i+=Math.floor(.5),a+=1,on.x=10*t.mw*16*1-on.w,l.dt>-1&&(on.x-=16),on.y=on.y%160+10*i*16),"S"===l.dir&&(a+=Math.floor(.5),i+=1,on.y=10*t.mh*16*1-on.h,l.dt>-1&&(on.y-=16),on.x=on.x%160+10*a*16),"W"===l.dir&&(i+=Math.floor(.5),on.x=0,l.dt>-1&&(on.x=16),on.y=on.y%160+10*i*16)))}function Q(){var e,n,r,o,l,a,i,h,f,y;for(e=0;e<Un.d.length;e++)n=Un.d[e],r=1*(n.x-Un.x),o=1*(n.y-Un.y),l=j(j(on.x),10),a=j(j(on.x+on.w),10),i=j(j(on.y),10),h=j(j(on.y+on.h),10),f=10*Un.mw*16*1,y=10*Un.mh*16*1,"N"===n.dir&&(r+=Math.floor(.5)),"E"===n.dir&&(o+=Math.floor(.5),r+=1),"S"===n.dir&&(r+=Math.floor(.5),o+=1),"W"===n.dir&&(o+=Math.floor(.5)),t.performance.now()-on.dc>400&&(on.x<=0&&-1===on.xd&&"W"===n.dir&&r===l&&o===i&&Z(n.r2,"E",n.y),on.y<=0&&-1===on.yd&&"N"===n.dir&&r===l&&o===i&&Z(n.r2,"S",n.x),on.x+on.w>=f&&1===on.xd&&"E"===n.dir&&r===a&&o===i&&Z(n.r2,"W",n.y),on.y+on.h>=y&&0!==on.yd&&Math.abs(on.ya)>5&&"S"===n.dir&&r===l&&(o===h||o===i)&&Z(n.r2,"N",n.x))}function V(){var r,o,l,a,h,f;Bn&&(null===Un&&(Tn=Hn),r=ze.width,o=ze.height,l=r,a=o,Hn>Tn&&(l=r*Tn/Hn,l=r-l,a=o*Tn/Hn,a=o-a),Tn>=Hn&&(Un!==On&&(Ge.clearRect(0,0,r,o),Ue.clearRect(0,0,r,o),Un=On,Un.v=!0,vn=On.map.tiles,Cn=On.map.map,In=10*On.map.height,Wn=10*On.map.width,kn=10*On.map.height*16,bn=10*On.map.width*16,K(On,Ln,Rn),e.title=Un.c.name,history.pushState(null,null,"#"+e.title),un.length=0),l=r*(Tn-Hn)/Hn,a=o*(Tn-Hn)/Hn),Nn.width=r,Nn.height=o,Dn.clearRect(0,0,r,o),i(),n(),Dn.drawImage(Xe,0,0),Dn.drawImage(Ye,0,0),Dn.drawImage(ze,0,0),qe.clearRect(0,0,r,o),Ye.style.display="none",Xe.style.display="none",Dn.globalCompositeOperation="destination-in",h=on.x+on.w/2-An-l/2,f=on.y+on.h/2-zn-a/2,Dn.beginPath(),Dn.rect(h,f,l,a),Dn.fillStyle="black",Dn.fill(),qe.drawImage(Nn,0,0),Tn+=2*Hn*(ln/1e3),Tn>2*Hn&&(Tn=0,Ze=!0,On=null,Bn=!1,Ye.style.display="initial",Xe.style.display="initial",on.dc=t.performance.now()))}function Z(t,e,n){Ln=e,Rn=n,Bn=!0,On=t,Ze=!1,null===t.map&&J(t)}function $(){var t=Ue.canvas,e=t.width/2,n=t.height/2;on.x-An+e>t.width?An=on.x-(t.width-e):on.x-e<An&&(An=on.x-e),on.y-zn+n>t.height?zn=on.y-(t.height-n):on.y-n<zn&&(zn=on.y-n),zn=~~(.5+zn),zn=~~(.5+zn)}function _(){var t=Je.canvas,e=t.width/2,n=t.height/2,r=16*(Un.x+j(j(j(on.x),10),1)),o=16*(Un.y+j(j(j(on.y),10),1));r-Xn+e>t.width?Xn=r-(t.width-e):Xn>r-e&&(Xn=r-e),o-Yn+n>t.height?Yn=o-(t.height-n):Yn>o-n&&(Yn=o-n),Yn=~~(.5+Yn),Yn=~~(.5+Yn)}function te(t,e,n){qn.f.length=0,qn.f.push({x:t,y:e}),qn.cr=n,qn.r.push(n)}function ee(t){for(var e,n,r=!0,o=re(),l=[],a=null;r;){for(e=0,a=ne(o),l.length=0,l.push(xe(a.x-1,a.y),xe(a.x+1,a.y),xe(a.x,a.y-1),xe(a.x,a.y+1)),n=0;4>n;n++)null===l[n]&&e++;e>2&&(r=!1)}te(a.x,a.y,t)}function ne(t){var e=M(0,t.length-1);return t[e]}function re(){var t,e=[];for(t=0;t<qn.rooms.length;t++)e=oe(e,qn.rooms[t]);return e}function oe(t,e){for(var n,r=e.x;r<e.x+e.mw;)le(r,e.y-1,1,1)&&t.push({x:r,y:e.y-1}),le(r,e.y+e.mh,1,1)&&t.push({x:r,y:e.y+e.mh}),r++;for(n=e.x;n<e.y+e.mh;)le(n,e.x-1,1,1)&&t.push({x:n,y:e.x-1}),le(n,e.x+e.mw,1,1)&&t.push({x:n,y:e.x+e.mw}),n++;return t}function le(t,e,n,r){return ae(t,e,n,r)&&!ie(t,e,n,r)}function ae(t,e,n,r){return t>0&&e>0&&t+n<qn.width&&e+r<qn.height}function ie(t,e,n,r){for(var o=null,l=0;l<qn.rooms.length;){o=qn.rooms[l];{if(!(o.x>t+n-1||o.x+o.mw-1<t||o.y>e+r-1||o.y+o.mh-1<e))return!0;l++}}return!1}function he(t){for(var e,n=0,r=null,o=!1,l=100;qn.rooms.length>1&&!o;){for(n=0,n+=fe(t),n+=ye(t),n+=de(t),n+=ue(t),1===t.r.rooms.length&&n>0&&(o=!0),e=0;e<t.d.length;e++)r=t.d[e],Pe(r,t).r===t.r&&(o=!0);l--,0===l&&(o=!0)}}function fe(t){for(var e,n,r,o,l=null,a=null,i=null,h=null,f=[],y=t.x;y<t.x+t.mw;)a=xe(y,t.y-1),null!==a&&f.push({x:y,y:t.y,o:a}),y++;for(e=0,n=0;n<f.length;n++){for(l=f[n],r=!1,o=0;o<t.d.length;o++)t.d[o].r2===l.o&&(r=!0);Math.random()>Gn||E(t.d,l)>=0||r||(i=ke(l.x,l.y,"N",t,l.o),h=ke(l.x,l.y-1,"S",l.o,t),t.d.push(i),i.o=h,h.o=i,l.o.d.push(h),e++)}return e}function ye(t){for(var e,n,r,o,l=null,a=null,i=null,h=null,f=[],y=t.x;y<t.x+t.mw;)a=xe(y,t.y+t.mh),null!==a&&f.push({x:y,y:t.y+t.mh-1,o:a}),y++;for(e=0,n=0;n<f.length;n++){for(l=f[n],r=!1,o=0;o<t.d.length;o++)t.d[o].r2===l.o&&(r=!0);Math.random()>Gn||E(t.d,l)>=0||r||(i=ke(l.x,l.y,"S",t,l.o),h=ke(l.x,l.y+1,"N",l.o,t),t.d.push(i),i.o=h,h.o=i,l.o.d.push(h),e++)}return e}function de(t){for(var e,n,r,o,l=null,a=null,i=null,h=null,f=[],y=t.y;y<t.y+t.mh;)a=xe(t.x-1,y),null!==a&&f.push({x:t.x,y:y,o:a}),y++;for(e=0,n=0;n<f.length;n++){for(l=f[n],r=!1,o=0;o<t.d.length;o++)t.d[o].r2===l.o&&(r=!0);Math.random()>Gn||E(t.d,l)>=0||r||(i=ke(l.x,l.y,"W",t,l.o),h=ke(l.x-1,l.y,"E",l.o,t),t.d.push(i),i.o=h,h.o=i,l.o.d.push(h),e++)}return e}function ue(t){for(var e,n,r,o,l=null,a=null,i=null,h=null,f=[],y=t.y;y<t.y+t.mh;)a=xe(t.x+t.mw,y),null!==a&&f.push({x:t.x+t.mw-1,y:y,o:a}),y++;for(e=0,n=0;n<f.length;n++){for(l=f[n],r=!1,o=0;o<t.d.length;o++)t.d[o].r2===l.o&&(r=!0);Math.random()>Gn||E(t.d,l)>=0||r||(i=ke(l.x,l.y,"E",t,l.o),h=ke(l.x+1,l.y,"W",l.o,t),i.o=h,h.o=i,t.d.push(i),l.o.d.push(h),e++)}return e}function xe(t,e){for(var n=null,r=0;r<qn.rooms.length;){n=qn.rooms[r];{if(!(n.x>t||n.x+n.mw-1<t||n.y>e||n.y+n.mh-1<e))return n;r++}}return null}function ce(t,e,n,r){var o,l=null;for(o=0;o<t.d.length;o++)if(l=t.d[o],l.dir===r&&l.x===t.x+e&&l.y===t.y+n)return l;return null}function me(t){for(var e=0,n=qn.rooms.length;e++<10*t&&qn.rooms.length<n+t;)se()}function se(){var t=ne(qn.f);try{pe(we(t.x,t.y))}catch(e){console.log(qn,t,e)}}function pe(t){if(null===t||!le(t.x,t.y,t.mw,t.mh))return!1;var e=[];e=ge(e,t),qn.f=oe(e,t),0===qn.f.length&&console.log(e,t,oe(e,t)),t.c=qn.cr.color,qn.rooms.push(t),qn.cr.rooms.push(t),he(t)}function oe(t,e){for(var n,r=e.x;r<e.x+e.mw;)le(r,e.y-1,1,1)&&t.push({x:r,y:e.y-1}),le(r,e.y+e.mh,1,1)&&t.push({x:r,y:e.y+e.mh}),r++;for(n=e.y;n<e.y+e.mh;)le(e.x-1,n,1,1)&&t.push({x:e.x-1,y:n}),le(e.x+e.mw,n,1,1)&&t.push({x:e.x+e.mw,y:n}),n++;return t}function ge(t,e){for(var n=0;n<qn.f.length;n++)qn.f[n].x>=e.x-1&&qn.f[n].x<=e.x+e.mw&&qn.f[n].y>=e.y&&qn.f[n].y<=e.y+e.mh-1||qn.f[n].x>=e.x&&qn.f[n].x<=e.x+e.mw-1&&qn.f[n].y>=e.y-1&&qn.f[n].y<=e.y+e.mh||t.push(qn.f[n]);return t}function we(t,e){for(var n,r=0,o=1,l=1;r++<25&&(o<qn.cr.maxW||l<qn.cr.maxH)&&Math.random()<.9;)n=parseInt(4*Math.random()),0===n&&l<qn.cr.maxH&&le(t,e-1,o,l+1)&&(e--,l++),1===n&&l<qn.cr.maxH&&le(t,e,o,l+1)&&l++,2===n&&o<qn.cr.maxW&&le(t-1,e,o+1,l)&&(t--,o++),3===n&&o<qn.cr.maxW&&le(t,e,o+1,l)&&o++;return ve(t,e,o,l,qn.cr)}function ve(t,e,n,r,o){return{x:t,y:e,mw:n,mh:r,c:null,r:o,s:-1,sx:0,sy:0,sr:!1,v:!1,d:[],map:null}}function ke(t,e,n,r,o){return{x:t,y:e,dt:-1,dir:n,r1:r,r2:o,o:null}}function be(){var t,e,n=null,r=null;for(t=0;t<qn.rooms.length;t++)for(n=qn.rooms[t],n.s=-1,e=0;e<n.d.length;e++)r=n.d[e],r.dt=-1}function Se(){var t,e,n,r=null,o=null,l=null,a=null;for(t=0;t<qn.r.length;t++)for(o=qn.r[t],a=ne(o.rooms),a.s=(t+1)%Kn.length,e=0;e<o.rooms.length;e++)for(a=o.rooms[e],n=0;n<a.d.length;n++)r=a.d[n],l=Pe(r,a).r,l!==o&&-1===r.o.dt&&(r.o.dt=(t+1)%Kn.length)}function Me(t){-1===on.keys.indexOf(t.s)&&t.s>-1&&(on.keys.push(t.s),je())}function je(){var t,e,n,r,o,l,a;for(t=0;t<qn.rooms.length;t++){for(e=!1,n=qn.rooms[t],on.keys.indexOf(n.s)>-1&&(n.s=-1,null!==n.map&&(r=n.map.map.indexOf(9),r>-1&&(n.map.map[r]=0))),o=0;o<n.d.length;o++)l=n.d[o],on.keys.indexOf(l.dt)>-1&&(l.dt=-1,e=!0);if(e&&null!==n.map)for(-1===n.s,a=0;a<n.map.map.length;a++)n.map.map[a]>1&&on.keys.indexOf(n.map.map[a]-1)>-1&&(n.map.map[a]=0)}}function Pe(t,e){return t.r1===e?t.r2:t.r1}function Ee(){qn={width:0,height:0,rooms:[],f:[],r:[],cr:0},Jn=0,qn.width=80,qn.height=48,te(40,24,Fe()),me(1)}function Fe(){var t=Ce(Kn[Jn],parseInt(3*Math.random())+parseInt(3*Math.random())+1,parseInt(3*Math.random())+parseInt(3*Math.random())+1,Jn);return Jn=(Jn+1)%Kn.length,t}function Ce(t,e,n,r){return{color:t,maxW:e,maxH:n,id:r,rooms:[]}}function We(){Ee()}function Ie(){se()}function Le(){ee(Fe())}function Re(){be(),Se()}var Oe,Be,Ne,De,Te,He,Ae,ze,Xe,Ye,qe,Ue,Ge,Je,Ke,Qe,Ve,Ze,$e,_e,tn,en,nn,rn,on,ln,an,hn,fn,yn,dn,un,xn,cn,mn,sn,pn,gn,wn,vn,kn,bn,Sn,Mn,jn,Pn,En,Fn,Cn,Wn,In,Ln,Rn,On,Bn,Nn,Dn,Tn,Hn,An,zn,Xn,Yn,qn,Un,Gn,Jn,Kn,Qn=e.getElementById("f"),Vn=e.createElement("canvas");for(Vn.height=16,Vn.width=16,Oe=Vn.getContext("2d"),Be=0,Ne=0,De=[],Te=0,He=!1,Ae=0,Ze=!0,$e=!0,_e=new CustomEvent("frame"),tn=t.performance.now(),en=t.performance.now(),nn={},rn={},on={x:-1,y:-1,w:16,h:32,img:null,xd:0,yd:1,xa:0,ya:0,maxa:5,jf:7,jh:50,js:0,j:0,ju:0,ht:0,mj:1,a:0,"ῼ":5,dc:t.performance.now(),"mῼ":5,keys:[]},ln=tn-en,an=[on],hn={a:65,w:87,s:83,d:68,space:32,shift:16,ctrl:17,alt:18,tab:9,debug:192},p("keydown",C),p("keyup",W),p("resize",k),p("DOMContentLoaded",v),p("frame",b),p("frame",V),p("mousemove",I),p("mousedown",L),p("mouseup",R),p("contextmenu",B),t.addEventListener("resize",g),e.addEventListener("DOMContentLoaded",g),e.addEventListener("mousedown",g),e.addEventListener("mouseup",g),e.addEventListener("keydown",g),e.addEventListener("keyup",g),e.addEventListener("frame",g),e.addEventListener("mousemove",g),e.addEventListener("contextmenu",g),fn=0,yn=0,dn=0,un=[],xn=t.performance.now(),cn=!1,mn=150,sn=[0,0,0,0,0],pn=-1,gn=-1,wn=0,vn=0,kn=0,bn=0,Sn=vn,Mn=vn,jn=[],Pn=[],En=0;100>En;En++)Pn[En]=0;for(Fn="1111111111111111111100000000000000000000000000000000000000000000000000000000000011111111111111111111,1100000011111000001111110000111100000011110000001111000000111100000111110000111111000000111100000011,1000000001110000001111100001110001001000000000000000000000000000000000000111100011111111111111111111,1111111111111000011100000000000000000000000011000000011110000000000000000000000011000000111100000111,1111000011110000001111000000111100000011110001111111000000001100000000110000000011111111111111111111,1111111111100000000010000000001000000000100000000010000000001000000000100000000010000011111000000011,1111111111000000000100000000010000000001000000000100000000010000000001000000000110000000011100000001,1111000011110000001111000000111100000011110001111100000111110000111111000011111111111111111111111111,1110000011110000000100000000000000000000000011000000001100000000000000000000000011000000111100000111,1100000011111000001100110000110000000011000000001100000000110000000111000000111111000000111100000011,1100000011111000001111110000001100000000110000000011000000001100000111110000111111000000111100000011".split(","),jn.push({map:Pn,type:0}),En=0;En<Fn.length;En++)jn.push(q(En+1,Fn[En]));Cn=null,Wn=0,In=0,Ln=0,Rn=0,On=null,Bn=!1,Nn=e.createElement("canvas"),Dn=Nn.getContext("2d"),Tn=0,Hn=1,An=0,zn=0,Xn=0,Yn=0,qn=null,Un=null,Gn=.2,Jn=0,Kn=[{bg:"#BBBBBB",bd:"#A0A0A0",o:"#CFCFCF",l:"#FFFFFF",name:"Dungeon"},{bd:"#990000",bg:"#FF3333",o:"#FF0000",l:"#FF0000",name:"Fire"},{bd:"#006600",bg:"#00BB00",o:"#00BB00",l:"#00FF00",name:"Air"},{bd:"#000066",bg:"#3333FF",o:"#0000FF",l:"#0000FF",name:"Water"},{bg:"#9F9F9F",bd:"#555555",o:"#555555",l:"#000000",name:"Earth"}]}(window,document);