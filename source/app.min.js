!function(t,n){function r(){var t,n,r,a,i,h,f,d,y,u;for(Dn.strokeStyle=jr.c.bd,Dn.lineWidth=2,q(),Ln.fillStyle=jr.c.bd,Ln.fillRect(0,0,Bn.width,Bn.height),Ln.fillStyle=jr.c.bg,Ln.clearRect(0-wr,0-vr,nr,tr),t=k(wr)-1,n=k(vr)-1,r=k(wr)+k(In.width)+2,a=k(vr)+k(In.height)+2,0>t&&(t=0),0>n&&(n=0),r>_n&&(r=_n),a>_n&&(a=_n),i=n;a>i;i++)for(h=0,f=16*-_n*2,d=0,Ln.fillStyle=jr.c.bg,u=t;r>u;u++)0!==hr[S(u,i,_n)]&&(h+=16,f===16*-_n*2&&(f=16*u-wr),y=0>i-1?-1:hr[S(u,i-1,_n)],0===y&&(d=1)),(0===hr[S(u,i,_n)]||u===r-1)&&e(i,f,h,d),(0===hr[S(u,i,_n)]||u===r-1)&&(h=0,f=16*-_n*2,d=0);for(i=n;a>i;i++)for(u=t;r>u;u++)hr[S(u,i,_n)]>1&&(9===hr[S(u,i,_n)]&&jr.s>-1?Ln.fillStyle=Cr[jr.s].l:9!==hr[S(u,i,_n)]&&(Ln.fillStyle=Cr[hr[S(u,i,_n)]-2].l),e(i,16*u-wr,16,!0));o(t,n,r,a,1),o(t,n,r,a,4),l(t,n,r,a,2),l(t,n,r,a,8)}function e(t,n,r,e){var o=n,l=16*t-vr;1===e?Ln.fillRect(o,l-5,r,21):Ln.fillRect(o,l,r,16)}function o(t,n,r,e,o){var l,i,h,f,d,y,u,x,m,c,s,g,p,w;for(l=t;r>l;l++)for(i=0,h=16*-_n*2,f=0,d=0,y=n;e>y;y++)u=hr[S(l+1,y-1,_n)],x=hr[S(l,y-1,_n)],m=hr[S(l-1,y-1,_n)],1===o?(d=hr[S(l-1,y,_n)],0>l-1&&(d=-1)):4===o&&(d=hr[S(l+1,y,_n)],l+1>_n-1&&(d=-1)),0!==hr[S(l,y,_n)]&&1>d&&(i+=16,h===16*-_n*2&&(0===x&&(f=1),h=16*y-vr)),(0===hr[S(l,y,_n)]||y===e-1||d>0)&&(Dn.beginPath(),c=h,s=16*l-wr,g=c+i,p=16*(l+1)-wr,w=s,4===o&&(w=p),f&&(c-=5),(4===o&&0===u||1===o&&0===m)&&d>0?a(w,c,w,g+3):a(w,c,w,g),Dn.closePath(),Dn.stroke()),(0===hr[S(l,y,_n)]||y===e-1||d>0)&&(i=0,h=16*-_n*2,f=0)}function l(t,n,r,e,o){var l,i,h,f,d,y,u,x,m,c;for(l=n;e>l;l++)for(i=0,h=16*-_n*2,f=0,d=0,y=t;r>y;y++)2===o?0>l-1?d=-1:(d=hr[S(y,l-1,_n)],f=1):8===o&&(d=hr[S(y,l+1,_n)],l+1>_n-1&&(d=-1)),0!==hr[S(y,l,_n)]&&1>d&&(i+=16,h===16*-_n*2&&(h=16*y-wr)),(0===hr[S(y,l,_n)]||y===r-1||d>0)&&(Dn.beginPath(),u=h,x=16*l-vr,m=u+i,c=16*(l+1)-vr,2===o?1===f?(a(u,x-5,m,x-5),a(u,x+3,m,x+3)):a(u,x,m,x):8===o&&a(u,c,m,c),Dn.closePath(),Dn.stroke()),(0===hr[S(y,l,_n)]||y===r-1||d>0)&&(i=0,h=16*-_n*2,f=0)}function a(t,n,r,e){Dn.moveTo(t,n),Dn.lineTo(r,e)}function i(){var t,n,r,e,o;for(U(),Mn=16*jr.x+16*k(k(k(Xn.x),10),1),Cn=16*jr.y+16*k(k(k(Xn.y),10),1),An.width=150,An.height=150,Hn.clearRect(0,0,An.width,An.height),En.length=0,Hn.lineWidth=2,Hn.fillStyle="#000",t=0;t<Sr.r.length;t++)for(n=0;n<Sr.r[t].rooms.length;n++)r=Sr.r[t].rooms[n],e=16*r.x-br,o=16*r.y-kr,e+16*r.mw>0&&o+16*r.mh>0&&e<An.width&&o<An.height&&(Hn.beginPath(),Hn.rect(e,o,16*r.mw,16*r.mh),Hn.fill(),Hn.closePath());h("bg","bd",function(t,n,r){t.v&&(Hn.beginPath(),Hn.rect(n,r,16*t.mw,16*t.mh),Hn.fill(),Hn.stroke(),Hn.closePath())},Hn),Fn.clearRect(0,0,16,16),h("bg","bd",function(t,n,r){t.v&&(Fn.beginPath(),Fn.rect(n/16*2,r/16*2,2*t.mw,2*t.mh),Fn.fill(),Fn.stroke(),Fn.closePath())},Fn),Er.href=Wr.toDataURL(),h(0,"bg",y,Hn),h(0,0,f,Hn),x()}function h(t,n,r,e){var o,l,a,i,h,f=e||Hn;for(o=0;o<Sr.r.length;o++)for("string"==typeof t&&(f.fillStyle=Sr.r[o].color[t]),"string"==typeof n&&(f.strokeStyle=Sr.r[o].color[n]),l=0;l<Sr.r[o].rooms.length;l++)a=Sr.r[o].rooms[l],i=16*a.x-br,h=16*a.y-kr,i+16*a.mw>0&&h+16*a.mh>0&&i<An.width&&h<An.height&&r(a,i,h,f)}function f(t){var n,r,e,o,l;if(t.v){for(n=null,r=null,e=0;e<t.d.length;e++)n=t.d[e],n.dt>-1&&(r=Cr[n.dt].l,o=0,l=0,"N"===n.dir&&(o=5),"S"===n.dir&&(o=5,l=16),"W"===n.dir&&(o=-3,l=8),"E"===n.dir&&(o=13,l=8),d(16*n.x+o,16*n.y+l,r));t.s>-1&&(r=Cr[t.s].l,d(16*(t.x+t.mw/2)-3,16*(t.y+t.mh/2),"rgba(0,0,0,0)",r))}}function d(t,n,r,e){var o=3;Hn.beginPath(),Hn.arc(t+o-br,n-kr,o,0,2*Math.PI,!1),Hn.fillStyle=r,Hn.fill(),e&&(Hn.lineWidth=2,Hn.strokeStyle=e,Hn.stroke()),Hn.closePath()}function y(t){var n,r,e,o,l,a;if(t.v)for(n=null,r=0;r<t.d.length;r++)n=t.d[r],e=t.x+"-"+t.y+"-"+n.r2.x+"-"+n.r2.y,o=n.r2.x+"-"+n.r2.y+"-"+t.x+"-"+t.y,-1===En.indexOf(o)&&-1===En.indexOf(e)&&(l=16*n.x,a=16*n.y,"N"===n.dir&&u(l+4,a,l+16-4,a),"S"===n.dir&&u(l+4,16*(n.y+1),l+16-4,16*(n.y+1)),"W"===n.dir&&u(l,a+4,l,a+16-4),"E"===n.dir&&u(16*(n.x+1),a+4,16*(n.x+1),a+16-4),En.push(e))}function u(t,n,r,e){Hn.beginPath(),Hn.moveTo(t-br,n-kr),Hn.lineTo(r-br,e-kr),Hn.stroke(),Hn.closePath()}function x(){var t,n,r,e;for(Pn||(zn.width=An.width,zn.height=An.height,Tn.lineWidth=1,Pn=!0),On.fillStyle="#000000",t=0;t<Zn.length;t++)n=Zn[t],r=(15-15*(Xn.ῼ/Xn.mῼ)).toString(16),On.fillStyle="#"+r+r+"0000",On.fillRect(n.x-wr,n.y-vr,n.w,n.h);Tn.clearRect(0,0,zn.width,zn.height),Wn+=2*(Yn/1e3),Wn%=2,e=1,Wn>1&&(e=0),Rn!==e&&(Tn.fillStyle="rgba(200,200,255,"+.6*e+")",Tn.strokeStyle="rgba(200,200,255,"+.8*e+")"),Tn.beginPath(),Tn.rect(Mn-br,Cn-kr,16,16),Tn.fill(),Tn.stroke(),Tn.closePath(),Fn.beginPath(),Fn.fillStyle="rgba(200,200,255,1)",Fn.strokeStyle="rgba(200,200,255,1)",Fn.rect((Mn-br)/16*2,(Cn-kr)/16*2,2,2),Fn.fill(),Fn.stroke(),Fn.closePath(),Rn=e}function m(t,n){Qn[t]||(Qn[t]=[]),Qn[t].push(n)}function c(t){var n,r=t.type;if(Qn[r]&&Qn[r].length>0)for(n=0;n<Qn[r].length;n++)Qn[r][n](t)}function s(t){return n.getElementById(t)}function g(){var t,n,r,e,o,l;for(In=s("p"),Nn=s("b"),Bn=s("t"),An=s("m"),zn=s("i"),On=In.getContext("2d"),Dn=Nn.getContext("2d"),Ln=Bn.getContext("2d"),Hn=An.getContext("2d"),Tn=zn.getContext("2d"),p(),bn(),t=0;t<Cr.length;t++){for(n=b(1,2),r=0;n>r;r++)kn();t+1<Cr.length&&Sn()}jn(),e=Sr.rooms[0].d[0],o=e.dir,l=e.x,("E"===e.dir||"W"===e.dir)&&(l=e.y),z(Sr.rooms[0],o,l),v()}function p(){Nn.width=In.width=Bn.width=t.innerWidth>300?300:t.innerWidth,Nn.height=In.height=Bn.height=t.innerHeight>300?300:t.innerHeight}function w(){var t,n;if(qn){for(t=0;t<Zn.length;t++)n=Zn[t],E(n),n.x=F(n.x),n.y=F(n.y),I(n),R(n),W(n),A(),P(n);On.clearRect(0,0,In.width,In.height),Dn.clearRect(0,0,Nn.width,Nn.height),r(),i()}}function v(){Jn=t.performance.now(),Yn=Jn-Kn,Kn=Jn,n.dispatchEvent(Gn),Un&&requestAnimationFrame(v)}function b(t,n){return Math.floor(Math.random()*(n-t+1)+t)}function k(t,n){var r=t%(n||16);return(t-r)/(n||16)}function S(t,n,r){return n*r+t}function j(t,n){var r,e,o;if("object"==typeof n){for(r=0;r<t.length;r++)if(e=!0,"object"==typeof t[r]){for(o in n)if(t[r][o]!==n[o]){e=!1;break}if(e===!0)return r}return-1}return t.indexOf(n)}function F(t){return~~(.5+t)}function M(t){for(var n in $n)$n[n]===t.keyCode&&t.preventDefault();Vn[t.keyCode]!==t.type&&t.keyCode===$n.space&&(Xn.j=1),Vn[t.keyCode]=t.type,t.keyCode===$n.d?Xn.xd=1:t.keyCode===$n.a&&(Xn.xd=-1)}function C(t){for(var n in $n)$n[n]===t.keyCode&&t.preventDefault();Vn[t.keyCode]!==t.type&&t.keyCode===$n.space&&(Xn.j=0),Vn[t.keyCode]=t.type,(t.keyCode===$n.d||t.keyCode===$n.a)&&(Vn[$n.d]&&Vn[$n.a]?Vn[$n.d]===t.type&&Vn[$n.a]===t.type&&(Xn.xd=0):Xn.xd=0)}function E(t){t.xa=t.xa+t.xd/60*Yn,t.xa>t.maxa&&(t.xa=t.maxa),t.xa<-t.maxa&&(t.xa=-t.maxa),0===t.xd&&(t.xa>0?t.xa=t.xa+-2/60*Yn:t.xa<0&&(t.xa=t.xa+2/60*Yn),(t.xa<1/60*Yn&&t.xa>-1/60*Yn||1===t.yd||-1===t.yd)&&(t.xa=0)),t.x=t.x+t.xa}function W(t){t.j&&-1!==t.yd&&t.ju<t.mj&&(t.mj>1&&0===t.ju&&1===t.yd&&t.ju++,(0===t.ju&&0===t.yd||t.ju>0||t.mj>1)&&(t.yd=-1,t.ya=-t.jf,t.js=t.y,t.ju++),t.ht=0),(0===t.yd||!t.j||t.ht>t.jh)&&(t.yd=1),1===t.yd&&(t.j=0,t.ya=t.ya+t.jf/2/60*Yn),0===t.yd&&(t.ya>0?t.ya=t.ya+-1/60*Yn:t.ya<0&&(t.ya=t.ya+1/60*Yn),t.ya<1/60*Yn&&t.ya>-1/60*Yn&&(t.ya=0)),t.ya>t.maxa&&(t.ya=10),t.ht-=t.ya,t.ht=F(t.ht),t.y=t.y+t.ya}function P(t){var n=t.x%16,r=S(k(t.x),k(t.y+t.h),_n),e=S(k(t.x+t.w),k(t.y+t.h),_n),o=!1;o=0===n?B(hr[r]):B(hr[e])||B(hr[r]),(o||t.y+t.h>16*dr)&&1===t.yd&&(t.y=16*k(t.y),t.ya=0,t.yd=0,t.ju=0,t.j=0,t.ht=0)}function R(t){var n=t.x%16,r=S(k(t.x),k(t.y-t.h/2),_n),e=S(k(t.x+t.w),k(t.y-t.h/2),_n),o=!1;o=0===n?B(hr[r]):B(hr[r])||B(hr[e]),o&&1===t.j&&(t.y=16*k(t.y),t.ya=-1,t.yd=1,t.j=0,t.ht=0)}function I(t){var n=t.y%16,r=t.x%16,e=S(k(t.x),k(t.y-t.h/2),_n),o=S(k(t.x+t.w),k(t.y-t.h/2),_n),l=S(k(t.x),k(t.y),_n),a=S(k(t.x+t.w),k(t.y),_n),i=S(k(t.x),k(t.y+t.h/2),_n),h=S(k(t.x+t.w),k(t.y+t.h/2),_n),f=S(k(t.x),k(t.y+t.h),_n),d=S(k(t.x+t.w),k(t.y+t.h),_n),y=!1,u=!1;0===n?(y=B(hr[i])||B(hr[l]),u=B(hr[h])||B(hr[a])):16*k(t.y+t.h)>t.y+t.h?(y=B(hr[i])||B(hr[l])||B(hr[e]),u=B(hr[h])||B(hr[a])||B(hr[o])):(y=B(hr[i])||B(hr[l])||B(hr[f]),u=B(hr[h])||B(hr[a])||B(hr[d])),0===r?(u||t.x+t.w>16*fr||t.x<0)&&t.xa>0&&(t.x=16*k(t.x),t.xa=0):(u||t.x+t.w>16*fr||t.x<0)&&t.xa>0?(t.x=16*k(t.x),t.xa=0):(y||t.x+t.w>16*fr||t.x<0)&&t.xa<0&&(t.x=16*k(t.x+t.w),t.xa=0)}function B(t){return 9===t&&cn(jr),0!==t}function N(t,n){n=n.split("");for(var r=0;r<n.length;r++)n[r]=parseInt(n[r]);return{map:n,type:t}}function O(t){return{map:t.map.slice(0),type:t.type}}function L(t,n,r,e){var o,l,a,i,h,f,d,y,u,x,m,c,s,g,p,w=[],v=[],b=Math.max(t,n);for(o=0;b*b>o;o++)w[o]=0;for(w=e(w,t,n,b),a={},y=0;10*b>y;y++)for(u=0;10*b>u;u++)x=Math.floor(u/10),m=Math.floor(y/10),i=on(r,x,m,"N"),h=on(r,x,m,"E"),f=on(r,x,m,"S"),d=on(r,x,m,"W"),c=S(x,m,b),s=x+"-"+m,(u%10===0||y%10===0)&&(a[s]||(l=O(or[w[c]]),a[s]=l),l=a[s]),g=S(u,y,10*b),p=S(u%10,y%10,10),v[g]=l.map[p],0===y&&null===i&&10*t>u&&(v[g]=1),0===u&&null===d&&10*n>y&&(v[g]=1),y===10*n-1&&null===f&&10*t>u&&(v[g]=1),u===10*t-1&&null===h&&10*n>y&&(v[g]=1),0===y&&null!==i&&10*t>u&&i.dt>-1&&0===v[g]&&(v[g]=i.dt+2),0===u&&null!==d&&10*n>y&&d.dt>-1&&0===v[g]&&(v[g]=d.dt+2),y===10*n-1&&null!==f&&10*t>u&&f.dt>-1&&0===v[g]&&(v[g]=f.dt+2),u===10*t-1&&null!==h&&10*n>y&&h.dt>-1&&0===v[g]&&(v[g]=h.dt+2);return{map:v,width:t,height:n,size:b,tiles:10*b}}function D(t){var n,r,e,o;if(t.map=L(1*t.mw,1*t.mh,t,function(n,r,e,o){var l,a,i,h,f,d,y,u=0,x=0,m=0;for(l=0;o*o>l;l++)a=on(t,u,x,"N"),i=on(t,u,x,"E"),h=on(t,u,x,"S"),f=on(t,u,x,"W"),d=[1,3,4,9],y=[2,9,10,11],(0===u||0===x||u===r-1||x===e-1)&&(m=b(0,11)),(0===u||u===r-1)&&(m=y[b(0,3)]),(0===x||x===e-1)&&(m=d[b(0,3)]),(0===u&&0===x||u===r-1&&0===x||u===r-1&&x===e-1||0===u&&x===e-1)&&(m=9),1===t.mw&&(m=y[b(0,3)]),1===t.mh&&(m=d[b(0,3)]),(2===t.mw||2===t.mh)&&(0===u&&0===x&&(m=6),u===r-1&&0===x&&(m=7),0===u&&x===e-1&&(m=5),u===r-1&&x===e-1&&(m=8)),(a||h||i||f)&&(m=9),n[S(u,x,o)]=m,u++,u>r-1&&(u=0,x++),x>e-1&&(l=o*o);return n}),t.s>-1){for(n=b(1,1*t.mw)-1,r=b(1,1*t.mh)-1,e=b(1,9),o=b(1,9);0!==t.map.map[S(e,o,t.map.tiles)];)e=b(1,9),o=b(1,9);t.map.map[S(10*n+e,10*r+o,t.map.tiles)]=9}}function H(t,n,r){var e,o,l,a,i;for(e=0;e<t.d.length;e++)o=!1,l=t.d[e],l.dir===n&&(("N"===l.dir||"S"===l.dir)&&(o=r===l.x),("E"===l.dir||"W"===l.dir)&&(o=r===l.y),o&&(a=1*(l.x-t.x),i=1*(l.y-t.y),-1===Xn.y&&(Xn.y=10*i*16+80),-1===Xn.x&&(Xn.x=10*a*16+80),"N"===l.dir&&(a+=Math.floor(.5),Xn.y=0,l.dt>-1&&(Xn.y=16),Xn.x=Xn.x%160+10*a*16),"E"===l.dir&&(i+=Math.floor(.5),a+=1,Xn.x=10*t.mw*16*1-Xn.w,l.dt>-1&&(Xn.x-=16),Xn.y=Xn.y%160+10*i*16),"S"===l.dir&&(a+=Math.floor(.5),i+=1,Xn.y=10*t.mh*16*1-Xn.h,l.dt>-1&&(Xn.y-=16),Xn.x=Xn.x%160+10*a*16),"W"===l.dir&&(i+=Math.floor(.5),Xn.x=0,l.dt>-1&&(Xn.x=16),Xn.y=Xn.y%160+10*i*16)))}function A(){var n,r,e,o,l,a,i,h,f,d;for(n=0;n<jr.d.length;n++)r=jr.d[n],e=1*(r.x-jr.x),o=1*(r.y-jr.y),l=k(k(Xn.x),10),a=k(k(Xn.x+Xn.w),10),i=k(k(Xn.y),10),h=k(k(Xn.y+Xn.h),10),f=10*jr.mw*16*1,d=10*jr.mh*16*1,"N"===r.dir&&(e+=Math.floor(.5)),"E"===r.dir&&(o+=Math.floor(.5),e+=1),"S"===r.dir&&(e+=Math.floor(.5),o+=1),"W"===r.dir&&(o+=Math.floor(.5)),t.performance.now()-Xn.dc>400&&(Xn.x<=0&&-1===Xn.xd&&"W"===r.dir&&e===l&&o===i&&z(r.r2,"E",r.y),Xn.y<=0&&-1===Xn.yd&&"N"===r.dir&&e===l&&o===i&&z(r.r2,"S",r.x),Xn.x+Xn.w>=f&&1===Xn.xd&&"E"===r.dir&&e===a&&o===i&&z(r.r2,"W",r.y),Xn.y+Xn.h>=d&&0!==Xn.yd&&Math.abs(Xn.ya)>5&&"S"===r.dir&&e===l&&(o===h||o===i)&&z(r.r2,"N",r.x))}function T(){var e,o,l,a,h,f;mr&&(null===jr&&(gr=pr),e=In.width,o=In.height,l=e,a=o,pr>gr&&(l=e*gr/pr,l=e-l,a=o*gr/pr,a=o-a),gr>=pr&&(jr!==xr&&(Dn.clearRect(0,0,e,o),Ln.clearRect(0,0,e,o),jr=xr,jr.v=!0,_n=xr.map.tiles,hr=xr.map.map,dr=10*xr.map.height,fr=10*xr.map.width,tr=10*xr.map.height*16,nr=10*xr.map.width*16,H(xr,yr,ur),n.title=jr.c.name,history.pushState(null,null,"#"+n.title)),l=e*(gr-pr)/pr,a=o*(gr-pr)/pr),cr.width=e,cr.height=o,sr.clearRect(0,0,e,o),i(),r(),sr.drawImage(Bn,0,0),sr.drawImage(Nn,0,0),sr.drawImage(In,0,0),On.clearRect(0,0,e,o),Nn.style.display="none",Bn.style.display="none",sr.globalCompositeOperation="destination-in",h=Xn.x+Xn.w/2-wr-l/2,f=Xn.y+Xn.h/2-vr-a/2,sr.beginPath(),sr.rect(h,f,l,a),sr.fillStyle="black",sr.fill(),On.drawImage(cr,0,0),gr+=2*pr*(Yn/1e3),gr>2*pr&&(gr=0,qn=!0,xr=null,mr=!1,Nn.style.display="initial",Bn.style.display="initial",Xn.dc=t.performance.now()))}function z(t,n,r){yr=n,ur=r,mr=!0,xr=t,qn=!1,null===t.map&&D(t)}function q(){var t=Ln.canvas,n=t.width/2,r=t.height/2;Xn.x-wr+n>t.width?wr=Xn.x-(t.width-n):Xn.x-n<wr&&(wr=Xn.x-n),Xn.y-vr+r>t.height?vr=Xn.y-(t.height-r):Xn.y-r<vr&&(vr=Xn.y-r),vr=~~(.5+vr),vr=~~(.5+vr)}function U(){var t=Hn.canvas,n=t.width/2,r=t.height/2,e=16*(jr.x+k(k(k(Xn.x),10),1)),o=16*(jr.y+k(k(k(Xn.y),10),1));e-br+n>t.width?br=e-(t.width-n):br>e-n&&(br=e-n),o-kr+r>t.height?kr=o-(t.height-r):kr>o-r&&(kr=o-r),kr=~~(.5+kr),kr=~~(.5+kr)}function G(t,n,r){Sr.f.length=0,Sr.f.push({x:t,y:n}),Sr.cr=r,Sr.r.push(r)}function J(t){for(var n,r,e=!0,o=Q(),l=[],a=null;e;){for(n=0,a=K(o),l.length=0,l.push(en(a.x-1,a.y),en(a.x+1,a.y),en(a.x,a.y-1),en(a.x,a.y+1)),r=0;4>r;r++)null===l[r]&&n++;n>2&&(e=!1)}G(a.x,a.y,t)}function K(t){var n=b(0,t.length-1);return t[n]}function Q(){var t,n=[];for(t=0;t<Sr.rooms.length;t++)n=V(n,Sr.rooms[t]);return n}function V(t,n){for(var r,e=n.x;e<n.x+n.mw;)X(e,n.y-1,1,1)&&t.push({x:e,y:n.y-1}),X(e,n.y+n.mh,1,1)&&t.push({x:e,y:n.y+n.mh}),e++;for(r=n.x;r<n.y+n.mh;)X(r,n.x-1,1,1)&&t.push({x:r,y:n.x-1}),X(r,n.x+n.mw,1,1)&&t.push({x:r,y:n.x+n.mw}),r++;return t}function X(t,n,r,e){return Y(t,n,r,e)&&!Z(t,n,r,e)}function Y(t,n,r,e){return t>0&&n>0&&t+r<Sr.width&&n+e<Sr.height}function Z(t,n,r,e){for(var o=null,l=0;l<Sr.rooms.length;){o=Sr.rooms[l];{if(!(o.x>t+r-1||o.x+o.mw-1<t||o.y>n+e-1||o.y+o.mh-1<n))return!0;l++}}return!1}function $(t){for(var n,r=0,e=null,o=!1,l=100;Sr.rooms.length>1&&!o;){for(r=0,r+=_(t),r+=tn(t),r+=nn(t),r+=rn(t),1===t.r.rooms.length&&r>0&&(o=!0),n=0;n<t.d.length;n++)e=t.d[n],gn(e,t).r===t.r&&(o=!0);l--,0===l&&(o=!0)}}function _(t){for(var n,r,e,o,l=null,a=null,i=null,h=null,f=[],d=t.x;d<t.x+t.mw;)a=en(d,t.y-1),null!==a&&f.push({x:d,y:t.y,o:a}),d++;for(n=0,r=0;r<f.length;r++){for(l=f[r],e=!1,o=0;o<t.d.length;o++)t.d[o].r2===l.o&&(e=!0);Math.random()>Fr||j(t.d,l)>=0||e||(i=un(l.x,l.y,"N",t,l.o),h=un(l.x,l.y-1,"S",l.o,t),t.d.push(i),i.o=h,h.o=i,l.o.d.push(h),n++)}return n}function tn(t){for(var n,r,e,o,l=null,a=null,i=null,h=null,f=[],d=t.x;d<t.x+t.mw;)a=en(d,t.y+t.mh),null!==a&&f.push({x:d,y:t.y+t.mh-1,o:a}),d++;for(n=0,r=0;r<f.length;r++){for(l=f[r],e=!1,o=0;o<t.d.length;o++)t.d[o].r2===l.o&&(e=!0);Math.random()>Fr||j(t.d,l)>=0||e||(i=un(l.x,l.y,"S",t,l.o),h=un(l.x,l.y+1,"N",l.o,t),t.d.push(i),i.o=h,h.o=i,l.o.d.push(h),n++)}return n}function nn(t){for(var n,r,e,o,l=null,a=null,i=null,h=null,f=[],d=t.y;d<t.y+t.mh;)a=en(t.x-1,d),null!==a&&f.push({x:t.x,y:d,o:a}),d++;for(n=0,r=0;r<f.length;r++){for(l=f[r],e=!1,o=0;o<t.d.length;o++)t.d[o].r2===l.o&&(e=!0);Math.random()>Fr||j(t.d,l)>=0||e||(i=un(l.x,l.y,"W",t,l.o),h=un(l.x-1,l.y,"E",l.o,t),t.d.push(i),i.o=h,h.o=i,l.o.d.push(h),n++)}return n}function rn(t){for(var n,r,e,o,l=null,a=null,i=null,h=null,f=[],d=t.y;d<t.y+t.mh;)a=en(t.x+t.mw,d),null!==a&&f.push({x:t.x+t.mw-1,y:d,o:a}),d++;for(n=0,r=0;r<f.length;r++){for(l=f[r],e=!1,o=0;o<t.d.length;o++)t.d[o].r2===l.o&&(e=!0);Math.random()>Fr||j(t.d,l)>=0||e||(i=un(l.x,l.y,"E",t,l.o),h=un(l.x+1,l.y,"W",l.o,t),i.o=h,h.o=i,t.d.push(i),l.o.d.push(h),n++)}return n}function en(t,n){for(var r=null,e=0;e<Sr.rooms.length;){r=Sr.rooms[e];{if(!(r.x>t||r.x+r.mw-1<t||r.y>n||r.y+r.mh-1<n))return r;e++}}return null}function on(t,n,r,e){var o,l=null;for(o=0;o<t.d.length;o++)if(l=t.d[o],l.dir===e&&l.x===t.x+n&&l.y===t.y+r)return l;return null}function ln(t){for(var n=0,r=Sr.rooms.length;n++<10*t&&Sr.rooms.length<r+t;)an()}function an(){var t=K(Sr.f);try{hn(dn(t.x,t.y))}catch(n){console.log(Sr,t,n)}}function hn(t){if(null===t||!X(t.x,t.y,t.mw,t.mh))return!1;var n=[];n=fn(n,t),Sr.f=V(n,t),0===Sr.f.length&&console.log(n,t,V(n,t)),t.c=Sr.cr.color,Sr.rooms.push(t),Sr.cr.rooms.push(t),$(t)}function V(t,n){for(var r,e=n.x;e<n.x+n.mw;)X(e,n.y-1,1,1)&&t.push({x:e,y:n.y-1}),X(e,n.y+n.mh,1,1)&&t.push({x:e,y:n.y+n.mh}),e++;for(r=n.y;r<n.y+n.mh;)X(n.x-1,r,1,1)&&t.push({x:n.x-1,y:r}),X(n.x+n.mw,r,1,1)&&t.push({x:n.x+n.mw,y:r}),r++;return t}function fn(t,n){for(var r=0;r<Sr.f.length;r++)Sr.f[r].x>=n.x-1&&Sr.f[r].x<=n.x+n.mw&&Sr.f[r].y>=n.y&&Sr.f[r].y<=n.y+n.mh-1||Sr.f[r].x>=n.x&&Sr.f[r].x<=n.x+n.mw-1&&Sr.f[r].y>=n.y-1&&Sr.f[r].y<=n.y+n.mh||t.push(Sr.f[r]);return t}function dn(t,n){for(var r,e=0,o=1,l=1;e++<25&&(o<Sr.cr.maxW||l<Sr.cr.maxH)&&Math.random()<.9;)r=parseInt(4*Math.random()),0===r&&l<Sr.cr.maxH&&X(t,n-1,o,l+1)&&(n--,l++),1===r&&l<Sr.cr.maxH&&X(t,n,o,l+1)&&l++,2===r&&o<Sr.cr.maxW&&X(t-1,n,o+1,l)&&(t--,o++),3===r&&o<Sr.cr.maxW&&X(t,n,o+1,l)&&o++;return yn(t,n,o,l,Sr.cr)}function yn(t,n,r,e,o){return{x:t,y:n,mw:r,mh:e,c:null,r:o,s:-1,sx:0,sy:0,sr:!1,v:!1,d:[],map:null}}function un(t,n,r,e,o){return{x:t,y:n,dt:-1,dir:r,r1:e,r2:o,o:null}}function xn(){var t,n,r=null,e=null;for(t=0;t<Sr.rooms.length;t++)for(r=Sr.rooms[t],r.s=-1,n=0;n<r.d.length;n++)e=r.d[n],e.dt=-1}function mn(){var t,n,r,e=null,o=null,l=null,a=null;for(t=0;t<Sr.r.length;t++)for(o=Sr.r[t],a=K(o.rooms),a.s=(t+1)%Cr.length,n=0;n<o.rooms.length;n++)for(a=o.rooms[n],r=0;r<a.d.length;r++)e=a.d[r],l=gn(e,a).r,l!==o&&-1===e.o.dt&&(e.o.dt=(t+1)%Cr.length)}function cn(t){-1===Xn.keys.indexOf(t.s)&&t.s>-1&&(Xn.keys.push(t.s),sn())}function sn(){var t,n,r,e,o,l,a;for(t=0;t<Sr.rooms.length;t++){for(n=!1,r=Sr.rooms[t],Xn.keys.indexOf(r.s)>-1&&(r.s=-1,e=r.map.map.indexOf(9),e>-1&&(r.map.map[e]=0)),o=0;o<r.d.length;o++)l=r.d[o],Xn.keys.indexOf(l.dt)>-1&&(l.dt=-1,n=!0);if(n&&null!==r.map)for(-1===r.s,a=0;a<r.map.map.length;a++)r.map.map[a]>1&&Xn.keys.indexOf(r.map.map[a]-1)>-1&&(r.map.map[a]=0)}}function gn(t,n){return t.r1===n?t.r2:t.r1}function pn(){Sr={width:0,height:0,rooms:[],f:[],r:[],cr:0},Mr=0,Sr.width=80,Sr.height=48,G(40,24,wn()),ln(1)}function wn(){var t=vn(Cr[Mr],parseInt(3*Math.random())+parseInt(3*Math.random())+1,parseInt(3*Math.random())+parseInt(3*Math.random())+1);return Mr=(Mr+1)%Cr.length,t}function vn(t,n,r){return{color:t,maxW:n,maxH:r,rooms:[]}}function bn(){pn()}function kn(){an()}function Sn(){J(wn())}function jn(){xn(),mn()}var Fn,Mn,Cn,En,Wn,Pn,Rn,In,Bn,Nn,On,Ln,Dn,Hn,An,Tn,zn,qn,Un,Gn,Jn,Kn,Qn,Vn,Xn,Yn,Zn,$n,_n,tr,nr,rr,er,or,lr,ar,ir,hr,fr,dr,yr,ur,xr,mr,cr,sr,gr,pr,wr,vr,br,kr,Sr,jr,Fr,Mr,Cr,Er=n.getElementById("f"),Wr=n.createElement("canvas");for(Wr.height=16,Wr.width=16,Fn=Wr.getContext("2d"),Mn=0,Cn=0,En=[],Wn=0,Pn=!1,Rn=0,qn=!0,Un=!0,Gn=new CustomEvent("frame"),Jn=t.performance.now(),Kn=t.performance.now(),Qn={},Vn={},Xn={x:-1,y:-1,w:16,h:32,img:null,xd:0,yd:1,xa:0,ya:0,maxa:5,jf:7,jh:50,js:0,j:0,ju:0,ht:0,mj:1,a:0,"ῼ":5,dc:t.performance.now(),"mῼ":5,keys:[]},Yn=Jn-Kn,Zn=[Xn],$n={a:65,w:87,s:83,d:68,space:32,shift:16,ctrl:17,alt:18,tab:9,debug:192},m("keydown",M),m("keyup",C),m("resize",p),m("DOMContentLoaded",g),m("frame",w),m("frame",T),t.addEventListener("resize",c),n.addEventListener("DOMContentLoaded",c),n.addEventListener("mousedown",c),n.addEventListener("mouseup",c),n.addEventListener("keydown",c),n.addEventListener("keyup",c),n.addEventListener("frame",c),_n=0,tr=0,nr=0,rr=_n,er=_n,or=[],lr=[],ar=0;100>ar;ar++)lr[ar]=0;for(ir="1111111111111111111111111111110000000000000000000000000000001111111111111111111111111111111111111111,1100000011111000001111110000111100000011110000001111000000111100000111110000111111000000111100000011,1000000001110000001111100001110001001000000000000000000000000000000000000111100011111111111111111111,1111111111111000011100000000000000000000000011000000011110000000000000000000000011000000111100000111,1100000011110000001111000001111110000001111000000011110000001111100000111111000011111111111111111111,1111111111100000000110000000001100000000110001100011100011101110000011111100000111110000011111100001,1111111111100000000100000000010000000011000110001100110001110110000111010000111111000011111000011111,1100000011110000001111100000111000000111000000011100000011110000011111000011111111111111111111111111,1110000011110000000100000000000000000000000011000000001100000000000000000000000011000000111100000111,1100000011111000001100110000110000000011000000001100000000110000000111000000111111000000111100000011,1100000011111000001111110000001100000000110000000011000000001100000111110000111111000000111100000011".split(","),or.push({map:lr,type:0}),ar=0;ar<ir.length;ar++)or.push(N(ar+1,ir[ar]));hr=null,fr=0,dr=0,yr=0,ur=0,xr=null,mr=!1,cr=n.createElement("canvas"),sr=cr.getContext("2d"),gr=0,pr=1,wr=0,vr=0,br=0,kr=0,Sr=null,jr=null,Fr=.2,Mr=0,Cr=[{bg:"#BBBBBB",bd:"#A0A0A0",o:"#CFCFCF",l:"#FFFFFF",name:"Dungeon"},{bd:"#990000",bg:"#FF3333",o:"#FF0000",l:"#FF0000",name:"Fire"},{bd:"#006600",bg:"#00BB00",o:"#00BB00",l:"#00FF00",name:"Air"},{bd:"#000066",bg:"#3333FF",o:"#0000FF",l:"#0000FF",name:"Water"},{bg:"#9F9F9F",bd:"#555555",o:"#555555",l:"#000000",name:"Earth"}]}(window,document);